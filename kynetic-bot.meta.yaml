# Kynetic Bot - Meta Manifest
# Defines workflows, agents, conventions for the project

kynetic_meta: "1.0"

agents:
  - _ulid: 01KG2000000000000000000000
    id: claude
    name: Claude Code Agent
    description: Primary development agent for this project.
    capabilities:
      - code
      - test
      - refactor
      - review
    tools:
      - kspec
      - git
      - npm
    session_protocol:
      start: "kspec session start"
      checkpoint: null
      end: null
    conventions:
      - Always use kspec CLI, never edit YAML directly
      - Add notes when completing significant work

workflows:
  - _ulid: 01KG2001000000000000000000
    id: task-work-session
    trigger: manual
    description: Core pattern for working on a task. Full lifecycle from start through PR merge.
    steps:
      - type: check
        content: |
          Check for existing in_progress or pending_review tasks.
          Use: kspec session start (shows active work first)
          Priority: pending_review > in_progress > ready
        on_fail: |
          Inherit existing work instead of starting new.
          Pick up in_progress task and continue, or check PR status for pending_review.
          Only start new work if user explicitly says to ignore existing work.
      - type: action
        content: |
          Choose task to work on.
          Use: kspec tasks ready to see available tasks
          Or: kspec task get @task to see task details
        inputs:
          - name: task_ref
            description: Reference to the task (e.g., @task-slug)
            type: ref
      - type: check
        content: |
          Verify work is not already done.
          Check git history: git log --oneline --grep="feature-name"
          Read implementation code if it exists.
        on_fail: Mark task complete with "Already implemented" reason
      - type: action
        content: |
          Start the task.
          Use: kspec task start @task
          This marks the task in_progress.
      - type: action
        content: |
          Work on the task, adding notes as you go.
          Use: kspec task note @task "What you're doing..."
          Add notes during work, not just at end.
      - type: check
        content: All changes committed
        on_fail: |
          Commit changes with Task: @task trailer.
          Example: git commit -m "feat: description\n\nTask: @task-slug"
      - type: action
        content: |
          Submit task for review.
          Use: kspec task submit @task
          This marks the task pending_review (code done, awaiting merge).
      - type: action
        content: |
          Create PR.
          Use: /pr skill or gh pr create
          After PR created, EXIT this iteration.
          Ralph spawns a PR review subagent for holistic review of the session's work.
        exit: true
        exit_note: |
          PR review is a separate session with broader focus:
          - Review the PR changes holistically, not just task checklist
          - Check for unintended side effects or scope creep
          - Verify AC coverage: each acceptance criterion should have test with AC annotation
          - Check for inline AC comments (// AC: @spec-item ac-N) linking code to criteria
          - Verify tests cover the actual behavior, not just acceptance criteria
          - Consider code quality, maintainability, and consistency
          After PR merged: kspec task complete @task --reason "Summary"

  - _ulid: 01KG2002000000000000000000
    id: session-reflect
    trigger: session-end
    description: Structured reflection after work sessions. Surfaces learnings, identifies friction, and
      captures improvements for system evolution.
    steps:
      - type: action
        content: |
          Identify what worked well this session.
          Be specific: "categorizing items first" not "good planning".
          Consider: workflows, tools/commands, communication, decisions.
      - type: action
        content: |
          Identify friction points - where things were harder than needed.
          Focus on systemic issues, not one-off mistakes.
          Consider: repetitive steps, missing commands, context loss, workarounds.
      - type: action
        content: |
          Check if friction points are already tracked.
          Search specs, tasks, AND inbox before proposing new improvements.
          For each: note if already tracked, partially covered, or untracked.
        exit_criteria:
          - Searched specs for relevant features
          - Searched tasks for existing work
          - Searched inbox for captured ideas
      - type: action
        content: |
          For untracked friction, propose concrete improvements.
          Include: what it would do, how it helps, rough scope (small/medium/large).
      - type: decision
        content: Present findings to user - ask about each improvement one at a time
        options:
          - Worth capturing -> proceed to capture
          - Needs refinement -> discuss and refine
          - Not worth it -> skip and continue
          - Done with reflection -> complete workflow
      - type: action
        content: |
          Capture approved items using appropriate destination:
          - Actionable improvements: kspec inbox add "..." --tag reflection
          - Friction patterns: kspec meta observe friction "..."
          - Success patterns: kspec meta observe success "..."
          - Open questions: kspec meta question add "..."

  - _ulid: 01KG2003000000000000000000
    id: pr-review-merge
    trigger: pr-merge
    description: Quality gate for reviewing and merging PRs. Ensures all CI passes, all reviews
      addressed, all requests completed, and all threads resolved before merge.
    steps:
      - type: check
        content: All CI checks complete (none pending or running)
        on_fail: Wait for CI to finish. Do not merge while checks are running.
      - type: check
        content: All CI checks pass (green)
        on_fail: Fix failures, push changes, wait for CI to re-run and pass.
      - type: action
        content: |
          Read ALL review comments on the PR.
          Use: gh pr view --comments or GitHub UI
          Check for: automated reviews, human reviews, inline comments.
      - type: check
        content: All review feedback addressed
        on_fail: |
          Fix each issue raised by reviewers.
          Push changes and wait for re-review if needed.
      - type: action
        content: |
          Check for @claude mentions or other requests in comments.
          Look for actions the PR agent couldn't complete (limited permissions).
          Examples: add inbox items, run kspec commands, update tasks.
      - type: check
        content: All requested actions completed
        on_fail: Complete the actions yourself before proceeding.
      - type: check
        content: All review threads resolved in GitHub UI
        on_fail: Click "Resolve conversation" on each thread after addressing.
      - type: decision
        content: Ready to merge?
        options:
          - Yes - all checks green, all reviews addressed, all threads resolved
          - No - need user approval to merge with known issues
          - Skip - user explicitly said to merge anyway
      - type: action
        content: |
          Merge the PR.
          Use: gh pr merge (prefer merge commit to preserve trailers)
          Or: GitHub UI merge button

  - _ulid: 01KG2004000000000000000000
    id: inbox-triage
    trigger: session-start
    description: Systematic processing of inbox items into specs and tasks.
    steps:
      - type: action
        content: |
          Get context and list inbox items.
          Use: kspec session start --full
          Use: kspec inbox list
      - type: action
        content: |
          Categorize items by type:
          - Bugs
          - Spec gaps
          - Quick wins
          - Larger features (need plan mode)
          - Delete candidates
      - type: decision
        content: Process each item - is it still relevant?
        options:
          - No -> delete it
          - Yes, spec exists -> promote to task
          - Yes, need spec -> create spec first
          - Unclear -> leave for later
      - type: action
        content: |
          For behavior changes, follow spec-first approach:
          1. Check if spec covers the change
          2. Create or update spec with AC if needed
          3. Derive task or promote inbox item

  - _ulid: 01KG2007000000000000000000
    id: local-review
    trigger: manual
    description: Quality enforcement for pre-PR review. Verifies AC coverage with annotations, test
      quality (no fluff), and test isolation. Issues are flagged as MUST-FIX.
    steps:
      - type: action
        content: |
          Get spec reference and read acceptance criteria.
          Use: kspec item get @spec to see ACs
          Each AC needs test coverage.
        inputs:
          - name: spec_ref
            description: Reference to the spec item (e.g., @spec-slug)
            type: ref
      - type: check
        content: |
          Every AC has test coverage with // AC: annotation.
          Search tests for: // AC: @spec-ref ac-N
          Each acceptance criterion must have at least one test.
        on_fail: |
          MUST-FIX: Missing AC coverage is a blocking issue.
          List each AC without test coverage.
      - type: check
        content: |
          All tests validate real behavior (no fluff tests).
          Tests should fail if the feature breaks.
          Reject tests that always pass or only test implementation details.
        on_fail: |
          MUST-FIX: Identify and flag fluff tests.
          A test that doesn't validate behavior is not valid.
      - type: check
        content: |
          Tests are properly isolated.
          No shared mutable state across tests.
          Fresh fixtures for each test case.
        on_fail: |
          MUST-FIX: Tests must be properly isolated.
          Fix shared state issues and ensure cleanup.
      - type: action
        content: |
          Report findings.
          List all MUST-FIX issues that block PR creation.
          Non-blocking suggestions can be noted separately.

  - _ulid: 01KG2008000000000000000000
    id: pr-review-loop
    trigger: loop-pr-review
    description: |
      PR review subagent workflow for loop mode. Runs local review, verifies AC coverage
      and spec alignment, fixes issues, waits for CI, posts review comment, and merges
      with quality gates. Sequential execution (ralph waits).

      CRITICAL: After ANY push, must re-verify CI passes before merge. Prior CI checks
      are invalidated by new commits. Never assume prior green CI is still valid.
    steps:
      - type: action
        content: |
          Run local review workflow first.
          Use: /local-review skill or kspec workflow start @local-review

          This checks:
          - AC coverage (all spec ACs have test annotations)
          - Test quality (no fluff tests)
          - Test isolation
      - type: check
        content: |
          Verify all spec ACs linked to task have test coverage.

          Check test files for AC annotations: // AC: @spec-ref ac-N
          Cross-reference with spec ACs from task.spec_ref

          MUST-FIX if:
          - Spec has ACs but no tests reference them
          - Tests exist but don't cover all ACs
        on_fail: |
          Add missing test coverage before continuing.
          Tests must validate AC behavior, not just implementation.
      - type: check
        content: |
          Verify implementation matches spec requirements.

          This is NOT just "do tests pass" - verify:
          - Implementation aligns with spec description
          - All AC conditions are actually implemented
          - No deviation from spec without justification

          Read spec, read implementation, compare.
        on_fail: |
          Fix misalignment between spec and implementation.
          Update code to match spec, or note why deviation is necessary.
      - type: decision
        content: |
          Evaluate local-review findings.

          If MUST-FIX issues found:
          - Attempt to fix them in-place
          - Run tests after fixes
          - Push changes

          If issues cannot be resolved:
          - Mark task automation: needs_review with explanation
          - EXIT workflow

          Decision matrix:
          - MUST-FIX issues, can fix -> Fix and continue
          - MUST-FIX issues, cannot fix -> Mark needs_review, EXIT
          - Only advisory issues -> Continue with merge
          - No issues -> Continue with merge
      - type: action
        content: |
          Push changes (if any fixes were made).
          Use: git push

          This triggers CI to run on latest code.

          NOTE: Only push if changes were actually made during issue fixing.
      - type: check
        content: |
          Wait for CI to complete and pass.

          CRITICAL: This step MUST be executed EVERY time changes are pushed.
          Do not skip or assume prior CI checks are valid.

          Poll CI status until all checks complete.
          Use: gh pr view --json statusCheckRollup

          Do NOT proceed while checks are running or failing.
          VERIFY the checks ran against current HEAD (latest commit SHA).
        on_fail: |
          If CI fails:
          - Investigate failure
          - Fix if possible
          - Push changes
          - RETURN TO THIS STEP and wait for CI again (do not skip ahead)

          If cannot fix:
          - Mark task automation: needs_review with CI failure details
          - EXIT workflow
      - type: action
        content: |
          Post review summary as PR comment.

          Use: gh pr comment $PR_NUMBER --body "..."

          Include in comment:
          - AC coverage status (which ACs have tests)
          - Spec alignment check result
          - Any issues found and how they were resolved
          - Verdict (ready to merge or not)
      - type: action
        content: |
          Follow PR review merge gates.
          Use: kspec workflow start @pr-review-merge

          This ensures:
          - All CI checks pass
          - All review feedback addressed
          - All @claude requests completed
          - All review threads resolved

          Only merge when all gates pass.
      - type: check
        content: |
          Verify PR was successfully merged.
          Use: gh pr view --json state,mergedAt

          Confirm state is MERGED.
        on_fail: |
          If merge failed:
          - Check for conflicts or protection rules
          - Attempt resolution
          - If cannot resolve: mark automation: needs_review
          - EXIT workflow
      - type: action
        content: |
          Mark task completed with PR reference.
          Use: kspec task complete @task --reason "Merged in PR #N. <summary>"

          Include in reason:
          - PR number
          - Summary of what was implemented
          - Any notable changes or deviations
          - AC coverage confirmation

conventions:
  - _ulid: 01KG2005000000000000000000
    domain: commits
    rules:
      - Use conventional commit format (feat, fix, docs, refactor, test, chore)
      - Include Task trailer when completing task work
      - Include Spec trailer when implementing spec item
      - Keep subject line under 72 characters
    examples:
      - good: "feat: add user login flow\n\nTask: @add-auth"
        bad: "Added login"
      - good: "fix(auth): handle expired tokens"
        bad: "fixed bug"

  - _ulid: 01KG2006000000000000000000
    domain: notes
    rules:
      - Add notes during work, not just at end
      - Include context for decisions made
      - Reference related commits, PRs, or issues
    examples:
      - good: "Using retry with exponential backoff. Chose 3 max retries based on API rate limits."
        bad: "Done"

observations: []
