_ulid: 01KG4GB4JN84KJR979D8S8K757
slugs:
  - bot
title: Bot
type: module
status:
  maturity: draft
  implementation: implemented
description: Main bot orchestration layer that wires all components together to create a functioning
  Discord bot.
tags: []
depends_on: []
implements: []
relates_to:
  - "@channel-registry"
  - "@channel-lifecycle"
  - "@agent-lifecycle"
  - "@msg-routing"
  - "@mem-shadow-storage"
  - "@bot-config"
tests: []
traits: []
notes: []
features:
  - _ulid: 01KG4GBA2SE73ZB8MRF07HGX1K
    slugs:
      - bot-config
    title: Bot Configuration
    type: feature
    tags: []
    description: Environment configuration loading and validation using Zod schemas.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
    notes: []
    created: 2026-01-29T09:11:31.673Z
    acceptance_criteria:
      - id: ac-1
        given: environment variables set
        when: bot starts
        then: loads DISCORD_TOKEN, AGENT_COMMAND, KBOT_DATA_DIR with Zod validation
      - id: ac-2
        given: required variable missing
        when: config loaded
        then: throws descriptive error identifying the missing variable
      - id: ac-3
        given: optional variable missing
        when: config loaded
        then: uses sensible defaults (logLevel=info, healthCheckInterval=30000)
      - id: ac-4
        given: invalid value format
        when: validated
        then: returns Zod error with path and expected type
      - id: ac-5
        given: ESCALATION_CHANNEL environment variable set
        when: config loaded
        then: includes escalationChannel in config for dedicated escalation notifications
      - id: ac-6
        given: KBOT_DATA_DIR environment variable set
        when: config loaded
        then: interprets value as relative worktree directory name (e.g., '.kbot') to be combined with git
          root, not an absolute path
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG4GC3A9Y86BFZ87BM4D6N6W
    slugs:
      - bot-orchestration
    title: Bot Orchestration
    type: feature
    tags: []
    description: Main Bot class that wires ChannelRegistry, AgentLifecycle, SessionKeyRouter, and
      KbotShadow together. Handles message flow from channel to agent and back.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
      - "@trait-recoverable"
      - "@trait-graceful-shutdown"
      - "@trait-health-monitored"
    notes: []
    created: 2026-01-29T09:11:57.514Z
    acceptance_criteria:
      - id: ac-1
        given: valid config
        when: Bot.create() called
        then: initializes ChannelRegistry, AgentLifecycle, SessionKeyRouter, KbotShadow
      - id: ac-2
        given: Discord message received
        when: processed
        then: routes to session, ensures agent is running via AgentLifecycle, awaits response, and returns
          to caller
      - id: ac-3
        given: agent emits escalate event
        when: handled
        then: logs error with context including event reason and metadata
      - id: ac-4
        given: SIGTERM/SIGINT received
        when: shutdown triggered
        then: gracefully stops agent, drains messages, disconnects Discord
      - id: ac-5
        given: agent process crashes
        when: detected by health monitor
        then: attempts restart with backoff per AgentLifecycle behavior
      - id: ac-6
        given: agent emits escalate event
        when: escalation handler processes event
        then: sends notification to escalationChannel if configured, otherwise to lastActiveChannel
      - id: ac-7
        given: Bot.create() called
        when: determining project root
        then: uses 'git rev-parse --show-toplevel' to find git root, falling back to process.cwd() if not in
          a git repo
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG4GD4PBMEWWEDEN8HPA2DV5
    slugs:
      - bot-cli
    title: Bot CLI
    type: feature
    tags: []
    description: CLI entry point that bootstraps the bot, handles process signals, and manages graceful
      shutdown.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-graceful-shutdown"
      - "@trait-observable"
    notes: []
    created: 2026-01-29T09:12:31.692Z
    acceptance_criteria:
      - id: ac-1
        given: pnpm start or node dist/cli.js
        when: executed
        then: loads config, creates bot, starts listening
      - id: ac-2
        given: SIGINT (Ctrl+C)
        when: received
        then: initiates graceful shutdown
      - id: ac-3
        given: SIGTERM
        when: received
        then: initiates graceful shutdown
      - id: ac-4
        given: uncaught exception
        when: thrown
        then: logs error, attempts graceful shutdown, exits with code 1
      - id: ac-5
        given: unhandled promise rejection
        when: detected
        then: logs error, attempts graceful shutdown, exits with code 1
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG6YYA622KH258S8TKGC51NC
    slugs:
      - bot-storage-integration
    title: Bot Storage Integration
    type: feature
    tags: []
    description: Wire ConversationStore and SessionStore into Bot class to persist conversation turns
      and agent session events. The storage layer is implemented but not connected to message
      handling flow.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
    notes: []
    created: 2026-01-30T08:05:03.299Z
    acceptance_criteria:
      - id: ac-1
        given: Bot.create() called
        when: initialization completes
        then: ConversationStore and SessionStore are instantiated with shadow worktree path
      - id: ac-2
        given: user message received
        when: handleMessage() processes it
        then: conversation is retrieved or created, user turn appended with message_id for idempotency
      - id: ac-3
        given: new ACP session created
        when: agent prompt sent
        then: agent session record created in SessionStore with link to conversation
      - id: ac-4
        given: agent response completed
        when: response sent to channel
        then: assistant turn appended with agent_session_id reference
      - id: ac-5
        given: bot restarts
        when: conversation resumed by same session key
        then: previous turns are available via ConversationStore.readTurns()
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG75SF2WVAPV5P3DXBS91QP4
    slugs:
      - bot-identity
    title: System Prompt Identity Injection
    type: feature
    tags: []
    description: Prepends kbot identity context to ACP system prompt. Establishes kbot as a persistent
      general assistant with full system access, distinct from ad-hoc Claude Code sessions. Supports
      user-customizable identity via .kbot/identity.yaml.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes: []
    created: 2026-01-30T10:04:44.508Z
    acceptance_criteria:
      - id: ac-1
        given: bot starts
        when: creating ACP session
        then: prepends kbot base identity to system prompt (persistent general assistant, full system
          access)
      - id: ac-2
        given: .kbot/identity.yaml exists
        when: creating system prompt
        then: includes custom identity (name, role, boundaries) after base identity
