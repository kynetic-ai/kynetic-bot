_ulid: 01KG4GB4JN84KJR979D8S8K757
slugs:
  - bot
title: Bot
type: module
status:
  maturity: draft
  implementation: implemented
description: Main bot orchestration layer that wires all components together to create a functioning
  Discord bot.
tags: []
depends_on: []
implements: []
relates_to:
  - "@channel-registry"
  - "@channel-lifecycle"
  - "@agent-lifecycle"
  - "@msg-routing"
  - "@mem-shadow-storage"
  - "@bot-config"
tests: []
traits: []
notes: []
features:
  - _ulid: 01KG4GBA2SE73ZB8MRF07HGX1K
    slugs:
      - bot-config
    title: Bot Configuration
    type: feature
    tags: []
    description: Environment configuration loading and validation using Zod schemas.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
    notes: []
    created: 2026-01-29T09:11:31.673Z
    acceptance_criteria:
      - id: ac-1
        given: environment variables set
        when: bot starts
        then: loads DISCORD_TOKEN, AGENT_COMMAND, KBOT_DATA_DIR with Zod validation
      - id: ac-2
        given: required variable missing
        when: config loaded
        then: throws descriptive error identifying the missing variable
      - id: ac-3
        given: optional variable missing
        when: config loaded
        then: uses sensible defaults (logLevel=info, healthCheckInterval=30000)
      - id: ac-4
        given: invalid value format
        when: validated
        then: returns Zod error with path and expected type
      - id: ac-5
        given: ESCALATION_CHANNEL environment variable set
        when: config loaded
        then: includes escalationChannel in config for dedicated escalation notifications
      - id: ac-6
        given: KBOT_DATA_DIR environment variable set
        when: config loaded
        then: interprets value as relative worktree directory name (e.g., '.kbot') to be combined with git
          root, not an absolute path
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG4GC3A9Y86BFZ87BM4D6N6W
    slugs:
      - bot-orchestration
    title: Bot Orchestration
    type: feature
    tags: []
    description: Main Bot class that wires ChannelRegistry, AgentLifecycle, SessionKeyRouter, and
      KbotShadow together. Handles message flow from channel to agent and back.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
      - "@trait-recoverable"
      - "@trait-graceful-shutdown"
      - "@trait-health-monitored"
    notes: []
    created: 2026-01-29T09:11:57.514Z
    acceptance_criteria:
      - id: ac-1
        given: valid config
        when: Bot.create() called
        then: initializes ChannelRegistry, AgentLifecycle, SessionKeyRouter, KbotShadow
      - id: ac-2
        given: Discord message received
        when: processed
        then: routes to session, ensures agent is running via AgentLifecycle, awaits response, and returns
          to caller
      - id: ac-3
        given: agent emits escalate event
        when: handled
        then: logs error with context including event reason and metadata
      - id: ac-4
        given: SIGTERM/SIGINT received
        when: shutdown triggered
        then: gracefully stops agent, drains messages, disconnects Discord
      - id: ac-5
        given: agent process crashes
        when: detected by health monitor
        then: attempts restart with backoff per AgentLifecycle behavior
      - id: ac-6
        given: agent emits escalate event
        when: escalation handler processes event
        then: sends notification to escalationChannel if configured, otherwise to lastActiveChannel
      - id: ac-7
        given: Bot.create() called
        when: determining project root
        then: uses 'git rev-parse --show-toplevel' to find git root, falling back to process.cwd() if not in
          a git repo
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG4GD4PBMEWWEDEN8HPA2DV5
    slugs:
      - bot-cli
    title: Bot CLI
    type: feature
    tags: []
    description: CLI entry point that bootstraps the bot, handles process signals, and manages graceful
      shutdown.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-graceful-shutdown"
      - "@trait-observable"
    notes: []
    created: 2026-01-29T09:12:31.692Z
    acceptance_criteria:
      - id: ac-1
        given: pnpm start or node dist/cli.js
        when: executed
        then: loads config, creates bot, starts listening
      - id: ac-2
        given: SIGINT (Ctrl+C)
        when: received
        then: initiates graceful shutdown
      - id: ac-3
        given: SIGTERM
        when: received
        then: initiates graceful shutdown
      - id: ac-4
        given: uncaught exception
        when: thrown
        then: logs error, attempts graceful shutdown, exits with code 1
      - id: ac-5
        given: unhandled promise rejection
        when: detected
        then: logs error, attempts graceful shutdown, exits with code 1
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG6YYA622KH258S8TKGC51NC
    slugs:
      - bot-storage-integration
    title: Bot Storage Integration
    type: feature
    tags: []
    description: Wire ConversationStore and SessionStore into Bot class to persist conversation turns
      and agent session events. The storage layer is implemented but not connected to message
      handling flow.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
    notes: []
    created: 2026-01-30T08:05:03.299Z
    acceptance_criteria:
      - id: ac-1
        given: Bot.create() called
        when: initialization completes
        then: ConversationStore and SessionStore are instantiated with shadow worktree path
      - id: ac-2
        given: user message received
        when: handleMessage() processes it
        then: conversation is retrieved or created, user turn appended with message_id for idempotency
      - id: ac-3
        given: new ACP session created
        when: agent prompt sent
        then: agent session record created in SessionStore with link to conversation
      - id: ac-4
        given: agent response completed
        when: response sent to channel
        then: assistant turn appended with agent_session_id reference
      - id: ac-5
        given: bot restarts
        when: conversation resumed by same session key
        then: previous turns are available via ConversationStore.readTurns()
      - id: ac-6
        given: Bot initialized
        when: ContextRestorer created
        then: TurnReconstructor is wired with SessionStore for content retrieval during context restoration
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG75SF2WVAPV5P3DXBS91QP4
    slugs:
      - bot-identity
    title: System Prompt Identity Injection
    type: feature
    tags: []
    description: Prepends kbot identity context to ACP system prompt. Establishes kbot as a persistent
      general assistant with full system access, distinct from ad-hoc Claude Code sessions. Supports
      user-customizable identity via .kbot/identity.yaml.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes: []
    created: 2026-01-30T10:04:44.508Z
    acceptance_criteria:
      - id: ac-1
        given: bot starts
        when: creating ACP session
        then: prepends kbot base identity to system prompt (persistent general assistant, full system
          access)
      - id: ac-2
        given: .kbot/identity.yaml exists
        when: creating system prompt
        then: includes custom identity (name, role, boundaries) after base identity
      - id: ac-3
        given: identity file missing
        when: creating system prompt
        then: uses base identity only without error
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG8JGJFSV84D6HFB5J98G1W9
    slugs:
      - bot-pr-review
    title: PR Review Automation
    type: feature
    tags: []
    description: Automated PR review capability for ralph loop subagents. Includes local review (AC
      coverage, test quality), spec alignment verification, review comment posting to PR, and merge
      workflow. Required for ralph loop to properly review PRs in this project.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes:
      - _ulid: 01KG8JHJS5FBG07JBH333AJTT9
        created_at: 2026-01-30T23:06:52.069Z
        author: "@claude"
        content: >-
          ## Problem Discovery


          During automation triage, we discovered that the ralph loop's PR review subagent was not
          posting review feedback as comments on PRs. Investigation revealed:


          1. **Ralph loop spawns subagents** for pending_review tasks (code in
          kynetic-spec/src/ralph/subagent.ts)

          2. **Subagent is told to run** `/pr-review @task-ref` (see buildSubagentPrompt())

          3. **But kynetic-bot has no /pr-review skill** - only /pr (for creating PRs)

          4. **Result**: Agent improvises, PRs get merged, but no review comments posted


          Evidence:

          - Recent merged PRs (37, 38, 39) have empty comments and reviews arrays

          - Zero `gh pr comment` or `gh pr review` commands in session events.jsonl

          - Only phases in session: task-work and reflect (no pr-review phase)


          ## Root Cause


          kynetic-bot is missing:

          - `/pr-review` skill (exists in kynetic-spec/.claude/skills/pr-review/)

          - `/local-review` skill (exists in kynetic-spec/.claude/skills/local-review/)

          - `@pr-review-loop` workflow (exists in kynetic-spec/.kspec/kynetic.meta.yaml)

          - `@local-review` workflow


          ## Solution


          Port the PR review skills and workflows from kynetic-spec, with one key addition:

          **Add a step to post review findings as a PR comment** (the original kynetic-spec workflow
          also lacks this).


          ## Source Files to Port


          From kynetic-spec:

          - .claude/skills/pr-review/SKILL.md

          - .claude/skills/local-review/SKILL.md

          - .kspec/kynetic.meta.yaml (workflows: pr-review-loop, local-review)
        supersedes: null
      - _ulid: 01KG8M2J5GRHD107EQRMV5Q4PQ
        created_at: 2026-01-30T23:33:37.072Z
        author: "@claude"
        content: "All ACs implemented across PRs #40 and #41. AC-1 through AC-5: /local-review and
          /pr-review skills with workflows (PR #40). AC-6: GitHub Actions workflows - test.yml,
          claude-code-review.yml, pr-review-resolution-check.yml (PR #41). Note: GitHub Actions
          billing limit issue needs resolution for CI to run."
        supersedes: null
    created: 2026-01-30T23:06:19.001Z
    acceptance_criteria:
      - id: ac-1
        given: Ralph loop spawns PR review subagent for pending_review task
        when: Subagent invokes /pr-review @task-ref
        then: Skill is found and executes pr-review-loop workflow
      - id: ac-2
        given: PR review workflow runs local review step
        when: AC coverage check completes
        then: Findings include list of spec ACs and their test coverage status (covered/missing)
      - id: ac-3
        given: PR review workflow completes review checks
        when: Review findings are ready
        then: Summary is posted as PR comment via gh pr comment with AC coverage, spec alignment, and issues
          found
      - id: ac-4
        given: Review finds MUST-FIX issues (missing AC coverage, spec misalignment)
        when: Issues cannot be auto-fixed
        then: Task marked needs_review with explanation; PR not merged
      - id: ac-5
        given: All quality gates pass (AC coverage, spec alignment, CI green)
        when: Merge step executes
        then: PR merged and task completed with summary
      - id: ac-6
        given: PR created or updated
        when: GitHub Actions run
        then: Tests, typecheck, and build pass; Claude code review runs; unresolved thread check enforced
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KGENY5N35EFRFGRVD0ZMBSFX
    slugs:
      - wake-injection
    title: Wake Context Injection
    type: feature
    tags: []
    description: Injects restart context into the initial agent prompt when bot starts with a
      checkpoint. Extends the existing ContextRestorer pattern to include wake-up context before
      identity prompt.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
    notes: []
    created: 2026-02-02T08:01:36.931Z
    acceptance_criteria:
      - id: ac-1
        given: --checkpoint CLI arg
        when: bot starts
        then: reads and validates checkpoint
      - id: ac-2
        given: valid checkpoint with wake_context.prompt
        when: session created
        then: injects wake prompt BEFORE identity prompt
      - id: ac-3
        given: wake prompt injected
        when: agent receives it
        then: "marked with promptSource: 'system'"
      - id: ac-4
        given: checkpoint has pending_work
        when: wake prompt generated
        then: "includes 'You were working on: {pending_work}'"
      - id: ac-5
        given: checkpoint has instructions
        when: wake prompt generated
        then: "includes 'Instructions: {instructions}'"
      - id: ac-6
        given: checkpoint consumed
        when: startup completes
        then: file deleted, event emitted
      - id: ac-7
        given: no checkpoint
        when: initialization
        then: skips wake injection, identity only
      - id: ac-8
        given: wake prompt very large
        when: context limits approached
        then: truncates with warning, preserves essential info
  - _ulid: 01KGEP0HCXM6CX2KM55XAR88WR
    slugs:
      - bot-restart-api
    title: Bot Restart API
    type: feature
    tags: []
    description: Public API for kbot to request restarts from the supervisor. Provides requestRestart()
      method that writes checkpoint, sends IPC message, and initiates graceful shutdown.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
    notes: []
    created: 2026-02-02T08:02:54.493Z
    acceptance_criteria:
      - id: ac-1
        given: bot calls requestRestart(options)
        when: IPC available
        then: writes checkpoint, sends planned_restart
      - id: ac-2
        given: requestRestart called
        when: options.reason provided
        then: checkpoint includes restart_reason
      - id: ac-3
        given: requestRestart called
        when: options.wakePrompt provided
        then: checkpoint includes wake_context.prompt
      - id: ac-4
        given: requestRestart called
        when: options.pendingWork provided
        then: checkpoint includes wake_context.pending_work
