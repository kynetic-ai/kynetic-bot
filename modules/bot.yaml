_ulid: 01KG4GB4JN84KJR979D8S8K757
slugs:
  - bot
title: Bot
type: module
status:
  maturity: draft
  implementation: not_started
description: Main bot orchestration layer that wires all components together to create a functioning
  Discord bot.
tags: []
depends_on: []
implements: []
relates_to: []
tests: []
traits: []
notes: []
features:
  - _ulid: 01KG4GBA2SE73ZB8MRF07HGX1K
    slugs:
      - bot-config
    title: Bot Configuration
    type: feature
    tags: []
    description: Environment configuration loading and validation using Zod schemas.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
    notes: []
    created: 2026-01-29T09:11:31.673Z
    acceptance_criteria:
      - id: ac-1
        given: environment variables set
        when: bot starts
        then: loads DISCORD_TOKEN, AGENT_COMMAND, KBOT_DATA_DIR with Zod validation
      - id: ac-2
        given: required variable missing
        when: config loaded
        then: throws descriptive error identifying the missing variable
      - id: ac-3
        given: optional variable missing
        when: config loaded
        then: uses sensible defaults (logLevel=info, healthCheckInterval=30000)
      - id: ac-4
        given: invalid value format
        when: validated
        then: returns Zod error with path and expected type
  - _ulid: 01KG4GC3A9Y86BFZ87BM4D6N6W
    slugs:
      - bot-orchestration
    title: Bot Orchestration
    type: feature
    tags: []
    description: Main Bot class that wires ChannelRegistry, AgentLifecycle, SessionKeyRouter, and
      KbotShadow together. Handles message flow from channel to agent and back.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes: []
    created: 2026-01-29T09:11:57.514Z
    acceptance_criteria:
      - id: ac-1
        given: valid config
        when: Bot.create() called
        then: initializes ChannelRegistry, AgentLifecycle, SessionKeyRouter, KbotShadow
      - id: ac-2
        given: Discord message received
        when: processed
        then: routes to session, spawns agent if needed, gets response, sends back
      - id: ac-3
        given: agent emits escalate event
        when: handled
        then: logs error with context and optionally notifies configured channel
      - id: ac-4
        given: SIGTERM/SIGINT received
        when: shutdown triggered
        then: gracefully stops agent, drains messages, disconnects Discord
      - id: ac-5
        given: agent process crashes
        when: detected by health monitor
        then: attempts restart with backoff per AgentLifecycle behavior
