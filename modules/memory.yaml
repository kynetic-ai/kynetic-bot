_ulid: 01KG1RC9W69NND94E5VZHEYK3G
slugs:
  - memory
title: Memory
type: module
status:
  maturity: draft
  implementation: not_started
description: "Persistent state: kspec shadow branch sync, conversation storage, and context window management"
tags: []
depends_on: []
implements: []
relates_to: []
tests: []
traits: []
notes: []
features:
  - _ulid: 01KG1RDJ269GRVN88KT1EVKKHY
    slugs:
      - mem-shadow-storage
    title: Shadow Branch Storage
    type: feature
    tags: []
    description: .kbot/ worktree with git shadow branch for persistent memory storage
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-recoverable"
      - "@trait-observable"
      - "@trait-validated"
    notes: []
    created: 2026-01-28T07:34:50.694Z
    acceptance_criteria:
      - id: ac-1
        given: write operation occurs
        when: completed
        then: file atomically written to .kbot/
      - id: ac-2
        given: batch interval (5min) OR event threshold (100 events) reached
        when: triggered
        then: commits pending changes to shadow branch
      - id: ac-3
        given: .kbot/ worktree not found
        when: storage accessed
        then: returns clear error with init suggestion
      - id: ac-4
        given: sync operation occurs
        when: completed
        then: emits structured event (sync_start, sync_complete, sync_error)
      - id: ac-5
        given: invalid state data
        when: write attempted
        then: rejects with structured validation error
      - id: ac-6
        given: crash during batch commit
        when: restarted
        then: recovers from last successful commit
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KG1RDM4NVZVQP8XZ9DY2CSRY
    slugs:
      - mem-conversation
    title: Conversation Storage
    type: feature
    tags: []
    description: "Event-sourced conversation tracking: turns are pointers to session event ranges,
      content reconstructed on demand"
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-idempotent"
      - "@trait-recoverable"
      - "@trait-observable"
      - "@trait-validated"
    notes: []
    created: 2026-01-28T07:34:52.822Z
    acceptance_criteria:
      - id: ac-1
        given: user message received
        when: logged as prompt.sent event
        then: writes turn with (role, session_id, event_range) to turns.jsonl
      - id: ac-2
        given: first agent event received (message.chunk, tool.call, etc.)
        when: logged to session as session.update
        then: writes turn with (role, session_id, event_range) to turns.jsonl
      - id: ac-3
        given: subsequent agent event received
        when: logged to session
        then: updates existing assistant turn's event_range.end_seq
      - id: ac-4
        given: turn stored with event_range
        when: content needed
        then: reconstructed from session events via TurnReconstructor
      - id: ac-5
        given: turn reconstruction requested
        when: referenced events partially missing/corrupted
        then: returns partial content with [gap] markers
      - id: ac-6
        given: same message_id persisted twice
        when: saved
        then: only one turn appended (idempotent)
      - id: ac-7
        given: turn appended or updated
        when: completed
        then: emits structured event (turn_appended, turn_updated)
      - id: ac-8
        given: invalid turn data
        when: append attempted
        then: rejects with Zod validation error including field details
      - id: ac-9
        given: retry after timeout during turn append
        when: reprocessed
        then: state remains consistent; no duplicate turns created
      - id: ac-10
        given: crash mid-turn-append
        when: restarted
        then: recovers from last successfully appended turn
      - id: ac-11
        given: turn append fails
        when: error caught
        then: logs error with context including conversation_id, role, and session_id
    status:
      maturity: draft
      implementation: in_progress
    features:
      - _ulid: 01KGBGNJ9X5K4TBWVF6YJQH8MN
        slugs:
          - mem-turn-reconstruct
        title: Turn Reconstruction
        type: feature
        tags: []
        description: Reconstruct structured turn content from session events. Supports options for
          including/summarizing tool calls and filtering by event range.
        depends_on:
          - "@mem-agent-sessions"
        implements: []
        relates_to: []
        tests: []
        traits:
          - "@trait-recoverable"
          - "@trait-observable"
          - "@trait-validated"
        notes: []
        created: 2026-02-01T02:30:00.000Z
        acceptance_criteria:
          - id: ac-1
            given: turn with valid event_range
            when: reconstruction requested
            then: returns structured content from session events
          - id: ac-2
            given: referenced events partially missing
            when: reconstruction attempted
            then: returns partial content with [gap] markers and emits warning
          - id: ac-3
            given: reconstruction completes
            when: result returned
            then: emits reconstruction_completed event with stats
          - id: ac-4
            given: reconstruction options include summarizeTools
            when: tool.call and tool.result events processed
            then: "tool calls formatted as [tool: name | input_summary | status | outcome]"
          - id: ac-5
            given: invalid session_id or event_range provided
            when: reconstruction requested
            then: returns structured validation error with field details
          - id: ac-6
            given: event_range has start_seq > end_seq
            when: validated
            then: returns error indicating invalid range
          - id: ac-7
            given: tool input exceeds 100 characters
            when: summarized
            then: input truncated with ellipsis
          - id: ac-8
            given: tool.call event without matching tool.result
            when: summarized
            then: "formats as [tool: name | input | pending]"
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KG1RDP884TBCZV7QH03CV53M
    slugs:
      - mem-context-window
    title: Context Window Management
    type: feature
    tags: []
    description: Context window management with compaction to maintain optimal context size
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-recoverable"
      - "@trait-observable"
    notes:
      - _ulid: 01KG2VGNEPEAWHZ1EZRE5X6GR5
        created_at: 2026-01-28T17:48:12.630Z
        author: "@claude"
        content: Deferred - implement after core storage (@mem-shadow-storage, @mem-agent-sessions,
          @mem-conversation) is stable. Compaction and context management will be designed once we
          have experience with the basic JSONL storage patterns.
        supersedes: null
    created: 2026-01-28T07:34:54.984Z
    acceptance_criteria:
      - id: ac-1
        given: context approaches token limit
        when: new message added
        then: compacts older messages while preserving key context
      - id: ac-2
        given: semantic boundary exists in history
        when: compaction runs
        then: preserves boundary markers for topic continuity
      - id: ac-3
        given: user references earlier topic
        when: context assembled
        then: includes session file reference in context, allowing agent to read archived turns directly
      - id: ac-4
        given: compaction triggered
        when: summarizing older turns
        then: "uses Haiku via ACP to generate short summary capturing: topics discussed, key user
          instructions/notes, and session file reference"
    status:
      maturity: draft
      implementation: implemented
    features:
      - _ulid: 01KG8FY59KRCBWY1RBRDBRMMEN
        slugs:
          - mem-context-restore
        title: Context Restoration
        type: feature
        tags: []
        description: Generate context restoration prompt when rotating sessions - uses TurnReconstructor to
          rebuild structured turns from session events, with summary of older turns and file
          reference for full history access.
        depends_on:
          - "@mem-session-lifecycle"
          - "@mem-context-window"
        implements: []
        relates_to: []
        tests: []
        traits:
          - "@trait-recoverable"
        notes: []
        created: 2026-01-30T22:21:18.516Z
        acceptance_criteria:
          - id: ac-1
            given: New session created for existing conversation
            when: Context restoration runs
            then: Recent turns reconstructed from session events via TurnReconstructor up to 30% token budget
          - id: ac-2
            given: Conversation has turns beyond recent window
            when: Context restoration runs
            then: Older turns summarized via HaikuSummaryProvider
          - id: ac-3
            given: Turn contains tool calls
            when: Turn reconstructed for replay
            then: Tool calls optionally summarized based on token budget constraints
          - id: ac-4
            given: Context restoration prompt generated
            when: Prompt injected to session
            then: Includes session file reference .kbot/sessions/{id}/events.jsonl
          - id: ac-5
            given: Context restoration prompt generated
            when: Agent receives prompt
            then: "Format has sections: Summary, Recent History, Archived History reference"
          - id: ac-6
            given: HaikuSummaryProvider unavailable
            when: Context restoration runs
            then: Falls back to recent turns only; warning logged
          - id: ac-7
            given: Conversation has no prior turns
            when: New session created
            then: Identity prompt injected; no context restoration attempted
          - id: ac-8
            given: Single turn exceeds 30% token budget
            when: Turn selected for replay
            then: Turn truncated with [truncated] marker to fit budget
          - id: ac-9
            given: Turn pointer references session events
            when: Context restoration needs content
            then: Uses TurnReconstructor to rebuild structured turn from events
        features:
          - _ulid: 01KG8FZFY22TQ2WVM307GY4SH3
            slugs:
              - mem-turn-selection
            title: Token-Based Turn Selection
            type: feature
            tags: []
            description: Select turns for verbatim replay based on token budget (30% of context window), not
              turn count. Tool calls use summarized form for token estimation.
            depends_on:
              - "@mem-context-restore"
            implements: []
            relates_to: []
            tests: []
            traits:
              - "@trait-validated"
            notes: []
            created: 2026-01-30T22:22:02.178Z
            acceptance_criteria:
              - id: ac-1
                given: Turns exist for replay
                when: Selection runs with token budget
                then: Most recent turns fitting within 30% budget selected
              - id: ac-2
                given: Turn is a tool call
                when: Token estimation runs
                then: Summarized form tokens used, not original verbose output
              - id: ac-3
                given: Token budget calculated
                when: Selection complete
                then: Selected turns fit within budget with 5% margin
              - id: ac-4
                given: Turn content contains tool markers
                when: Tool detection runs
                then: Correctly identifies tool name and extracts brief result
            status:
              maturity: draft
              implementation: implemented
        status:
          maturity: draft
          implementation: in_progress
  - _ulid: 01KG2VD4BPPHV4QP9H5XNA87HR
    slugs:
      - mem-agent-sessions
    title: Agent Session Tracking
    type: feature
    tags: []
    description: Track all LLM interactions as JSONL events for audit trails
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-recoverable"
      - "@trait-observable"
      - "@trait-validated"
    notes: []
    created: 2026-01-28T17:46:16.822Z
    acceptance_criteria:
      - id: ac-1
        given: LLM prompt sent
        when: processed
        then: creates session with session.yaml (id, agent_type, status, started_at) and events.jsonl
      - id: ac-2
        given: streaming response
        when: chunks received
        then: appends message.chunk events with auto-assigned ts and seq (monotonically increasing)
      - id: ac-3
        given: tool call requested
        when: executed
        then: appends tool.call and tool.result events with correlation
      - id: ac-4
        given: session ended
        when: status updated
        then: sets ended_at timestamp and final status (completed/abandoned)
      - id: ac-5
        given: event appended
        when: completed
        then: emits structured event for observability
      - id: ac-6
        given: invalid event data
        when: append attempted
        then: rejects with Zod validation error
      - id: ac-7
        given: crash mid-session
        when: restarted
        then: marks orphaned sessions as abandoned
      - id: ac-8
        given: ACP SessionUpdate notification received
        when: update processed by bot
        then: persists full SessionUpdate as session.update event via SessionStore.appendEvent()
      - id: ac-9
        given: user message sent to agent
        when: prompt initiated
        then: logs prompt.sent event before sending to agent
    status:
      maturity: draft
      implementation: implemented
    features:
      - _ulid: 01KG8FWBE38KV5WTVDB3DK91F0
        slugs:
          - mem-session-lifecycle
        title: Session Lifecycle Management
        type: feature
        tags: []
        description: Manage ACP session lifecycle per conversation - reuse sessions until context limit
          (70%), then rotate with context restoration. Track context usage via /usage command with
          stderr parsing.
        depends_on:
          - "@mem-conversation"
          - "@mem-agent-sessions"
        implements: []
        relates_to: []
        tests: []
        traits:
          - "@trait-recoverable"
          - "@trait-observable"
        notes:
          - _ulid: 01KG8HGNGH7CCJAXJ9HT3SF9GJ
            created_at: 2026-01-30T22:48:53.521Z
            author: "@claude"
            content: AC-5, AC-6, AC-7 implementation delegated to child spec @mem-context-usage
            supersedes: null
        created: 2026-01-30T22:20:19.268Z
        acceptance_criteria:
          - id: ac-1
            given: Bot running with active ACP session for session key
            when: New message arrives
            then: Existing session reused if within 70% context limit
          - id: ac-2
            given: ACP session context exceeds 70% threshold
            when: New message arrives
            then: New session created with context restoration
          - id: ac-3
            given: Bot restarts
            when: Message arrives for known session key
            then: New session created with context restoration from persisted history
          - id: ac-4
            given: Session rotation occurs
            when: New session created
            then: Previous session marked completed in SessionStore
          - id: ac-5
            given: Agent response completes
            when: Usage check runs
            then: /usage command invoked and context usage captured from stderr
          - id: ac-6
            given: Context usage captured
            when: Update processed
            then: SessionLifecycleManager receives ContextUsageUpdate with token counts
          - id: ac-7
            given: /usage command fails or times out
            when: Error caught
            then: Session continues with stale usage data; warning logged
          - id: ac-8
            given: Multiple messages arrive for same session key
            when: Processing starts
            then: Messages serialized via per-key lock; share same session
          - id: ac-9
            given: Bot restarts with recent conversation (< 30 min)
            when: First message arrives
            then: Rebuild state from ConversationStore; context restoration injected
        features:
          - _ulid: 01KG8HG0ZBF8C3WN61V28Q9A54
            slugs:
              - mem-context-usage
            title: Context Usage Tracking
            type: feature
            tags: []
            description: Track context usage via /context command with stderr parsing. Provides token counts to
              SessionLifecycleManager for rotation decisions.
            depends_on: []
            implements: []
            relates_to: []
            tests: []
            traits:
              - "@trait-observable"
            notes: []
            created: 2026-01-30T22:48:32.491Z
            acceptance_criteria:
              - id: ac-1
                given: Agent process spawned
                when: Process writes to stderr
                then: Stderr output is captured programmatically (not inherited to parent)
              - id: ac-2
                given: Agent response completes
                when: Usage check triggered
                then: /context command sent to agent and response awaited
              - id: ac-3
                given: /context response captured from stderr
                when: Parsing completes
                then: ContextUsageUpdate emitted with model, token counts, and category breakdown
              - id: ac-4
                given: /context command fails or times out
                when: Error caught
                then: Session continues with stale usage data; warning logged
            status:
              maturity: draft
              implementation: implemented
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KG73AT8E8H2K6CAY3QTF8EQN
    slugs:
      - session-search
    title: Programmatic Session Search
    type: feature
    tags: []
    description: API for agents to programmatically search and parse archived sessions by ID. Enables
      selective retrieval of historical context without loading full session files.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes: []
    created: 2026-01-30T09:21:47.278Z
    status:
      maturity: deferred
