_ulid: 01KG1RC9W69NND94E5VZHEYK3G
slugs:
  - memory
title: Memory
type: module
status:
  maturity: draft
  implementation: not_started
description: "Persistent state: kspec shadow branch sync, conversation storage, and context window management"
tags: []
depends_on: []
implements: []
relates_to: []
tests: []
traits: []
notes: []
features:
  - _ulid: 01KG1RDJ269GRVN88KT1EVKKHY
    slugs:
      - mem-shadow-storage
    title: Shadow Branch Storage
    type: feature
    tags: []
    description: .kbot/ worktree with git shadow branch for persistent memory storage
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-recoverable"
      - "@trait-observable"
      - "@trait-validated"
    notes: []
    created: 2026-01-28T07:34:50.694Z
    acceptance_criteria:
      - id: ac-1
        given: write operation occurs
        when: completed
        then: file atomically written to .kbot/
      - id: ac-2
        given: batch interval (5min) OR event threshold (100 events) reached
        when: triggered
        then: commits pending changes to shadow branch
      - id: ac-3
        given: .kbot/ worktree not found
        when: storage accessed
        then: returns clear error with init suggestion
      - id: ac-4
        given: sync operation occurs
        when: completed
        then: emits structured event (sync_start, sync_complete, sync_error)
      - id: ac-5
        given: invalid state data
        when: write attempted
        then: rejects with structured validation error
      - id: ac-6
        given: crash during batch commit
        when: restarted
        then: recovers from last successful commit
  - _ulid: 01KG1RDM4NVZVQP8XZ9DY2CSRY
    slugs:
      - mem-conversation
    title: Conversation Storage
    type: feature
    tags: []
    description: "Two-layer conversation tracking: user threads linked to agent sessions via turns.jsonl"
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-idempotent"
      - "@trait-recoverable"
      - "@trait-observable"
      - "@trait-validated"
    notes: []
    created: 2026-01-28T07:34:52.822Z
    acceptance_criteria:
      - id: ac-1
        given: user message received
        when: processed
        then: creates/updates conversation with turn (role, content, ts, seq) in turns.jsonl
      - id: ac-2
        given: LLM response completed
        when: saved
        then: appends assistant turn with agent_session_id linking to @mem-agent-sessions
      - id: ac-3
        given: bot restarts
        when: conversation resumed
        then: recovers all turns from .kbot/ (skipping invalid JSON lines with warning)
      - id: ac-4
        given: same message_id persisted twice
        when: saved
        then: only one turn appended
      - id: ac-5
        given: turn appended
        when: completed
        then: emits structured event (turn_appended, conversation_created)
      - id: ac-6
        given: invalid turn data
        when: append attempted
        then: rejects with Zod validation error including field details
  - _ulid: 01KG1RDP884TBCZV7QH03CV53M
    slugs:
      - mem-context-window
    title: Context Window Management
    type: feature
    tags: []
    description: Context window management with compaction to maintain optimal context size
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes: []
    created: 2026-01-28T07:34:54.984Z
    acceptance_criteria:
      - id: ac-1
        given: context approaches token limit
        when: new message added
        then: compacts older messages while preserving key context
      - id: ac-2
        given: semantic boundary exists in history
        when: compaction runs
        then: preserves boundary markers for topic continuity
      - id: ac-3
        given: user references earlier topic
        when: context assembled
        then: retrieves relevant archived context
  - _ulid: 01KG2VD4BPPHV4QP9H5XNA87HR
    slugs:
      - mem-agent-sessions
    title: Agent Session Tracking
    type: feature
    tags: []
    description: Track all LLM interactions as JSONL events for audit trails
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-recoverable"
      - "@trait-observable"
      - "@trait-validated"
    notes: []
    created: 2026-01-28T17:46:16.822Z
    acceptance_criteria:
      - id: ac-1
        given: LLM prompt sent
        when: processed
        then: creates session with session.yaml (id, agent_type, status, started_at) and events.jsonl
      - id: ac-2
        given: streaming response
        when: chunks received
        then: appends message.chunk events with auto-assigned ts and seq (monotonically increasing)
      - id: ac-3
        given: tool call requested
        when: executed
        then: appends tool.call and tool.result events with correlation
      - id: ac-4
        given: session ended
        when: status updated
        then: sets ended_at timestamp and final status (completed/abandoned)
      - id: ac-5
        given: event appended
        when: completed
        then: emits structured event for observability
      - id: ac-6
        given: invalid event data
        when: append attempted
        then: rejects with Zod validation error
      - id: ac-7
        given: crash mid-session
        when: restarted
        then: marks orphaned sessions as abandoned
