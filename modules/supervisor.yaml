_ulid: 01KGENSV2ZE142KYVC2JYQYMWT
slugs:
  - supervisor
title: Supervisor
type: module
status:
  maturity: draft
  implementation: implemented
description: Supervisor package that spawns and manages the kbot process. Enables restart
  functionality with wake-up context preservation via IPC protocol and checkpoint files.
tags: []
depends_on: []
implements: []
relates_to: []
tests: []
traits: []
notes: []
features:
  - _ulid: 01KGENT244FBE2XG9EB9555H9A
    slugs:
      - supervisor-process-spawn
    title: Supervisor Process Spawn
    type: feature
    tags: []
    description: Core supervisor functionality that spawns kbot as a child process with IPC channel,
      handles signals, manages respawn with exponential backoff, and coordinates graceful shutdown.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
      - "@trait-health-monitored"
      - "@trait-graceful-shutdown"
    notes: []
    created: 2026-02-02T07:59:22.245Z
    acceptance_criteria:
      - id: ac-1
        given: supervisor starts
        when: spawn() called
        then: spawns kbot with IPC channel
      - id: ac-2
        given: kbot running
        when: supervisor receives SIGTERM
        then: sends SIGTERM to child, waits for graceful exit
      - id: ac-3
        given: kbot exits code 0
        when: exit detected
        then: supervisor exits cleanly (no respawn)
      - id: ac-4
        given: kbot exits non-zero
        when: exit detected
        then: respawns with exponential backoff
      - id: ac-5
        given: backoff reaches max (60s)
        when: spawn fails again
        then: emits escalation event, continues retrying
      - id: ac-6
        given: kbot spawned
        when: child starts
        then: logs PID, sets up IPC handlers
      - id: ac-7
        given: IPC channel setup fails
        when: spawn attempted
        then: logs error, retries spawn
      - id: ac-8
        given: supervisor crashes
        when: child running
        then: child orphaned, continues running (container/systemd restarts supervisor)
      - id: ac-9
        given: kbot exits non-zero unexpectedly
        when: supervisor detects crash
        then: creates crash checkpoint with last known state (if available) before respawn
  - _ulid: 01KGENVK19JERKH4DTWDRXPHFM
    slugs:
      - restart-checkpoint
    title: Restart Checkpoint
    type: feature
    tags: []
    description: Checkpoint file format for persisting restart context. Checkpoints store session state,
      restart reason, and wake-up context that survives restarts.
    depends_on:
      - "@supervisor-process-spawn"
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
      - "@trait-recoverable"
    notes: []
    created: 2026-02-02T08:00:12.330Z
    acceptance_criteria:
      - id: ac-1
        given: checkpoint created
        when: persisted
        then: writes to .kbot/checkpoints/{ulid}.yaml
      - id: ac-2
        given: checkpoint file
        when: validated
        then: "contains: session_id, restart_reason, wake_context.prompt"
      - id: ac-3
        given: restart_reason
        when: checkpoint created
        then: accepts 'planned', 'upgrade', 'crash'
      - id: ac-4
        given: checkpoint > 24 hours old
        when: bot starts
        then: ignores, logs warning
      - id: ac-5
        given: checkpoint consumed
        when: bot starts normally
        then: deletes file after wake injection
      - id: ac-6
        given: checkpoint corrupted
        when: validation fails
        then: logs error, starts without wake context
      - id: ac-7
        given: checkpoint format changes
        when: version field checked
        then: handles migration or rejects incompatible
      - id: ac-8
        given: checkpoint write fails
        when: disk full/permissions
        then: logs error, restart proceeds without checkpoint
    status:
      maturity: draft
      implementation: in_progress
  - _ulid: 01KGENWZX3HSXZT4PS0MAYYFZZ
    slugs:
      - restart-protocol
    title: Restart Protocol
    type: feature
    tags: []
    description: IPC message protocol between kbot and supervisor for coordinating planned restarts.
      Handles checkpoint lifecycle, acknowledgments, and restart sequencing.
    depends_on:
      - "@restart-checkpoint"
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
      - "@trait-observable"
    notes: []
    created: 2026-02-02T08:00:58.275Z
    acceptance_criteria:
      - id: ac-1
        given: kbot wants restart
        when: "sends { type: 'planned_restart', checkpoint } via IPC"
        then: supervisor acknowledges, initiates graceful restart
      - id: ac-2
        given: supervisor receives planned_restart
        when: checkpoint path provided
        then: verifies file exists before restarting
      - id: ac-3
        given: planned_restart acknowledged
        when: child exits code 0
        then: respawns with --checkpoint flag
      - id: ac-4
        given: checkpoint referenced
        when: respawn occurs
        then: path passed as CLI arg or env var
      - id: ac-5
        given: invalid IPC message
        when: parsed
        then: logs warning, ignores (no crash)
      - id: ac-6
        given: no IPC channel
        when: planned_restart attempted
        then: throws error
      - id: ac-7
        given: no ack received within 5s
        when: timeout elapsed
        then: logs warning, retries once
      - id: ac-8
        given: requestRestart called twice
        when: second call while first pending
        then: second call rejected with error
  - _ulid: 01KGENZCCJC9SBN1EJNZPXXK7P
    slugs:
      - shutdown-modes
    title: Shutdown Modes
    type: feature
    tags: []
    description: Soft and hard shutdown modes for graceful process termination. Handles in-flight
      message draining, timeout-based escalation to SIGKILL, and coordination during planned
      restarts.
    depends_on:
      - "@restart-protocol"
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-graceful-shutdown"
    notes: []
    created: 2026-02-02T08:02:16.594Z
    acceptance_criteria:
      - id: ac-1
        given: soft shutdown requested
        when: SIGTERM sent
        then: waits up to shutdownTimeout (30s default)
      - id: ac-2
        given: soft shutdown timeout exceeded
        when: child running
        then: sends SIGKILL, logs forced termination
      - id: ac-3
        given: supervisor receives SIGTERM
        when: in planned restart
        then: completes restart (no double-signal)
      - id: ac-4
        given: shutdown initiated
        when: child draining
        then: emits 'draining' event
      - id: ac-5
        given: hard shutdown requested
        when: kill('SIGKILL') called
        then: immediately sends SIGKILL
      - id: ac-6
        given: messages in-flight
        when: shutdown initiated
        then: waits for inflightCount to reach 0 (with timeout)
      - id: ac-7
        given: new message arrives
        when: during shutdown drain
        then: rejected with 'shutting down' error
      - id: ac-8
        given: planned restart in progress
        when: supervisor receives SIGTERM
        then: waits for planned restart to complete, then exits (no additional SIGTERM to child)
  - _ulid: 01KGEP20P61R0K3924GVNASJ04
    slugs:
      - supervisor-env
    title: Supervisor Environment
    type: feature
    tags: []
    description: Environment variables set by supervisor when spawning kbot. Allows kbot to detect
      supervised mode and access restart functionality.
    depends_on:
      - "@supervisor-process-spawn"
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
    notes: []
    created: 2026-02-02T08:03:42.919Z
    acceptance_criteria:
      - id: ac-1
        given: supervisor spawns child
        when: environment set
        then: KBOT_SUPERVISED=1 set
      - id: ac-2
        given: supervisor spawns child
        when: IPC open
        then: KBOT_SUPERVISOR_PID={pid} set
      - id: ac-3
        given: bot starts
        when: KBOT_SUPERVISED=1
        then: bot knows restart API available
      - id: ac-4
        given: restart after checkpoint
        when: child spawned
        then: KBOT_CHECKPOINT_PATH={path} in env
