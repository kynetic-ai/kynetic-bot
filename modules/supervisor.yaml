_ulid: 01KGENSV2ZE142KYVC2JYQYMWT
slugs:
  - supervisor
title: Supervisor
type: module
status:
  maturity: draft
  implementation: not_started
description: Supervisor package that spawns and manages the kbot process. Enables restart
  functionality with wake-up context preservation via IPC protocol and checkpoint files.
tags: []
depends_on: []
implements: []
relates_to: []
tests: []
traits: []
notes: []
features:
  - _ulid: 01KGENT244FBE2XG9EB9555H9A
    slugs:
      - supervisor-process-spawn
    title: Supervisor Process Spawn
    type: feature
    tags: []
    description: Core supervisor functionality that spawns kbot as a child process with IPC channel,
      handles signals, manages respawn with exponential backoff, and coordinates graceful shutdown.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-observable"
      - "@trait-health-monitored"
      - "@trait-graceful-shutdown"
    notes: []
    created: 2026-02-02T07:59:22.245Z
    acceptance_criteria:
      - id: ac-1
        given: supervisor starts
        when: spawn() called
        then: spawns kbot with IPC channel
      - id: ac-2
        given: kbot running
        when: supervisor receives SIGTERM
        then: sends SIGTERM to child, waits for graceful exit
      - id: ac-3
        given: kbot exits code 0
        when: exit detected
        then: supervisor exits cleanly (no respawn)
      - id: ac-4
        given: kbot exits non-zero
        when: exit detected
        then: respawns with exponential backoff
      - id: ac-5
        given: backoff reaches max (60s)
        when: spawn fails again
        then: emits escalation event, continues retrying
      - id: ac-6
        given: kbot spawned
        when: child starts
        then: logs PID, sets up IPC handlers
      - id: ac-7
        given: IPC channel setup fails
        when: spawn attempted
        then: logs error, retries spawn
      - id: ac-8
        given: supervisor crashes
        when: child running
        then: child orphaned, continues running (container/systemd restarts supervisor)
  - _ulid: 01KGENVK19JERKH4DTWDRXPHFM
    slugs:
      - restart-checkpoint
    title: Restart Checkpoint
    type: feature
    tags: []
    description: Checkpoint file format for persisting restart context. Checkpoints store session state,
      restart reason, and wake-up context that survives restarts.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-validated"
      - "@trait-recoverable"
    notes: []
    created: 2026-02-02T08:00:12.330Z
    acceptance_criteria:
      - id: ac-1
        given: checkpoint created
        when: persisted
        then: writes to .kbot/checkpoints/{ulid}.yaml
      - id: ac-2
        given: checkpoint file
        when: validated
        then: "contains: session_id, restart_reason, wake_context.prompt"
      - id: ac-3
        given: restart_reason
        when: checkpoint created
        then: accepts 'planned', 'upgrade', 'crash'
      - id: ac-4
        given: checkpoint > 24 hours old
        when: bot starts
        then: ignores, logs warning
      - id: ac-5
        given: checkpoint consumed
        when: bot starts normally
        then: deletes file after wake injection
      - id: ac-6
        given: checkpoint corrupted
        when: validation fails
        then: logs error, starts without wake context
      - id: ac-7
        given: checkpoint format changes
        when: version field checked
        then: handles migration or rejects incompatible
