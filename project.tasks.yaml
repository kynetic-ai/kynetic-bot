- _ulid: 01KG1QW1WPDYZZ7Q7SQQCCYMDF
  slugs: []
  title: Spec out core kynetic-bot functionality
  type: task
  spec_ref: null
  meta_ref: null
  status: pending_review
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags: []
  vcs_refs: []
  created_at: 2026-01-28T07:25:17.077Z
  started_at: 2026-01-28T07:25:32.707Z
  notes:
    - _ulid: 01KG1QWB61BTD9E260GBGMJ7FF
      created_at: 2026-01-28T07:25:26.593Z
      author: "@claude"
      content: |-
        ## Scope

        Create initial specification for kynetic-bot core functionality:
        - Cross-platform chat bot with web UI and mobile clients (UI deferred)
        - Leverages kspec for task management and memory/storage
        - Uses/extends ACP for agent execution (like kspec ralph mode)
        - Skills integration

        ## Reference Sources
        - moltbot (GitHub): UX/chat patterns and solved problems
        - ../kynetic: Robust ACP implementation, chat UI, skills
        - ../kynetic-spec: Task/memory foundation

        ## Focus
        Core functionality only - minimum for something functional. No UI specs yet.

        ## Approach
        1. Research all three reference sources
        2. Identify patterns, gaps, and opportunities
        3. Synthesize into spec items with acceptance criteria
        4. Cover explicit and implicit user expectations
      supersedes: null
    - _ulid: 01KG1R0PR4HWKQPTT94XKD8Z89
      created_at: 2026-01-28T07:27:49.508Z
      author: "@claude"
      content: |-
        ## Research Complete

        ### Moltbot Key Patterns
        - **Architecture**: Local-first Gateway control plane with WebSocket hub
        - **Platforms**: 13+ channels (WhatsApp, Telegram, Slack, Discord, Signal, iMessage, etc.)
        - **Session Keys**: Encodes agent:agentId:sessionType:peerInfo for routing
        - **Agent**: Pi runtime with tool streaming, subagent registry
        - **Memory**: Vector search (SQLite + embeddings), session compaction
        - **Skills**: Bundled, managed, workspace-level - skill.yaml + handlers
        - **Protocol**: JSON-RPC frames (req/res/event) over WebSocket

        ### Kynetic Key Patterns
        - **Architecture**: Hub (orchestrator) ↔ Lifeline (bridge) ↔ Agent (ephemeral)
        - **ACP**: JSON-RPC 2.0 framing, stdio communication, timeout management
        - **Sessions**: Semantic units, compaction triggers, crash recovery with lineage
        - **Skills**: MCP server integration, skill:// URI protocol
        - **Protocol**: Message envelopes with seq/ack, gap detection, idempotency
        - **State**: Task states (pending→ready→assigned→in_progress→completed)

        ### Kspec Key Patterns
        - **Shadow Branch**: Spec/task state separate from code, auto-commit
        - **Tasks**: Append-only notes, automation eligibility, failure tracking
        - **Specs**: module > feature > requirement hierarchy, Given/When/Then AC
        - **Traits**: Reusable AC bundles for cross-cutting concerns
        - **Ralph Mode**: Autonomous loop with circuit breaker, escalation on failures
        - **Meta-spec**: Agents, workflows, conventions, observations

        ### Spec Writing Guidelines
        - Use CLI commands, not manual YAML
        - AC format: given/when/then, concrete examples
        - 3-5 AC per item, independently testable
        - Traits for 3+ specs needing same behavior
        - Derive tasks from specs, add implementation notes
      supersedes: null
    - _ulid: 01KG1R48NSWMQHVF864SK5SH03
      created_at: 2026-01-28T07:29:46.169Z
      author: "@claude"
      content: |-
        ## Spec Structure Finalized

        ### Gap Analysis Summary
        - **Reusable from Kynetic (70%)**: ACP, session management, MCP tools, hub protocol
        - **Extend (15%)**: Session routing keys, kspec MCP tools, agent lifecycle
        - **Net-new (15%)**: Channel abstraction, DM policies, kspec memory integration

        ### Core Modules
        1. **messaging** - Conversation core (routing, transform, streaming, history)
        2. **channels** - Platform integration (registry, lifecycle, DM policy, media)
        3. **memory** - Context & persistence (kspec sync, conversation notes, context window)
        4. **agent** - Execution model (lifecycle, autonomous, skills, escalation)

        ### MVP Priority (Phase 1)
        1. msg-routing - Session key routing
        2. channel-registry - Plugin architecture
        3. mem-kspec-sync - Persistence foundation
        4. agent-lifecycle - Basic agent management

        ### Cross-Cutting Traits
        - @trait-idempotent - Message handler safety
        - @trait-observable - Event emission
        - @trait-recoverable - Crash recovery
        - @trait-rate-limited - Platform rate limits

        Next: Create kspec items with AC
      supersedes: null
    - _ulid: 01KG1RMXW0NCDJ06VXJBWA4QWA
      created_at: 2026-01-28T07:38:52.160Z
      author: "@claude"
      content: |-
        ## Spec Structure Created

        Created 4 modules with 15 features and 46 acceptance criteria:

        ### Modules
        - **@messaging** - Core message handling
        - **@channels** - Platform adapter system  
        - **@memory** - Persistent state management
        - **@agent** - Agent orchestration

        ### Features per Module

        **Messaging (4 features, 12 AC)**
        - @msg-routing - Session key-based routing (3 AC)
        - @msg-transform - Platform-agnostic normalization (3 AC)
        - @msg-streaming - Chunked response delivery (3 AC)
        - @msg-history - Semantic boundaries for context (3 AC)

        **Channels (4 features, 13 AC)**
        - @channel-registry - Plugin registration (3 AC)
        - @channel-lifecycle - Connection health checks (3 AC)
        - @channel-dm-policy - Pairing/open workflows (4 AC)
        - @channel-media - Media attachments (3 AC)

        **Memory (3 features, 9 AC)**
        - @mem-kspec-sync - Shadow branch integration (3 AC)
        - @mem-conversation - Conversation as notes (3 AC)
        - @mem-context-window - Compaction management (3 AC)

        **Agent (4 features, 12 AC)**
        - @agent-lifecycle - Spawn, monitor, restart (3 AC)
        - @agent-autonomous - Ralph-mode with circuit breaker (3 AC)
        - @agent-skills - Skill discovery and tools (3 AC)
        - @agent-escalation - Human handoff (3 AC)

        All items validated with kspec validate.
      supersedes: null
    - _ulid: 01KG1RNXD3J6MW7QM5DBRN8MVT
      created_at: 2026-01-28T07:39:24.451Z
      author: "@claude"
      content: |-
        ## Spec Creation Complete

        ### Created Structure
        - 4 modules: messaging, channels, memory, agent
        - 15 features with 46 acceptance criteria total
        - All in Given/When/Then format

        ### Files Created
        - .kspec/modules/messaging.yaml (4 features, 12 AC)
        - .kspec/modules/channels.yaml (4 features, 13 AC)
        - .kspec/modules/memory.yaml (3 features, 9 AC)
        - .kspec/modules/agent.yaml (4 features, 12 AC)

        ### Next Steps
        1. Review and refine AC based on implementation learnings
        2. Add cross-cutting traits (@trait-idempotent, @trait-recoverable, etc.)
        3. Derive tasks from specs when ready to implement
        4. Start with Phase 1 MVP: msg-routing, channel-registry, mem-kspec-sync, agent-lifecycle

        ### Session Continuity
        Research documented in previous notes. Spec structure follows:
        - Reuse kynetic ACP/session/MCP (70%)
        - Extend session routing, kspec MCP tools (15%)
        - Build channel abstraction, DM policies, kspec memory (15%)
      supersedes: null
    - _ulid: 01KG1S3XWC4PTKKET8JBJXGSSD
      created_at: 2026-01-28T07:47:03.692Z
      author: "@claude"
      content: |-
        ## Phase 2: Implementation Planning

        ### Objective
        Use plan mode to flesh out realistic implementation path, then:
        1. Derive tasks from specs
        2. Break down into granular, Ralph-automatable units
        3. Flesh out with implementation details and solid AC
        4. Handle unknowns as prerequisite tasks or user questions

        ### Success Criteria
        - Tasks are standalone (no session context needed)
        - Tasks have clear AC (no interpretation required)
        - Dependencies are explicit
        - Unknowns resolved before bulk work begins
      supersedes: null
    - _ulid: 01KG1SB9DFN8MBHYTYW6T0HRH0
      created_at: 2026-01-28T07:51:04.879Z
      author: "@claude"
      content: |-
        ## Implementation Research Complete

        ### Kynetic Reusable Components (with file paths)
        **ACP** (direct import):
        - /packages/lifeline/src/acp/client.ts - ACPClient class
        - /packages/lifeline/src/acp/framing.ts - JsonRpcFraming
        - /packages/lifeline/src/acp/handlers.ts - createHandlers()

        **Session Management** (adapt):
        - /packages/lifeline/src/session/semantic-units.ts - groupIntoUnits(), extractRecentUnits()
        - /packages/lifeline/src/session/compaction-trigger.ts - 70%/85% thresholds
        - /packages/lifeline/src/session/crash-recovery.ts - CrashRecoveryHandler

        **Hub Protocol** (reference):
        - /packages/shared/src/hub-protocol/core.ts - Envelope, error codes
        - /packages/shared/src/hub-protocol/session.ts - SessionUpdate types

        ### Kspec Programmatic APIs
        - initContext() - Detects shadow, loads manifest
        - createTask(), saveTask(), loadAllTasks() - Task CRUD
        - createNote(), createInboxItem() - Note/inbox creation
        - commitIfShadow() - Auto-persist to shadow branch
        - getReadyTasks() - Dependency-aware task filtering

        ### Moltbot Patterns to Adopt
        - Session keys: agent:{agentId}:{channel}:{peerKind}:{peerId}
        - Channel plugin interface with configSchema, sendMessage, normalizeTarget
        - DM pairing: pending request → code → approval → allow-list
        - Streaming coalescing: minChars/idleMs thresholds
        - Platform-specific chunking limits (2000-4000 chars)
      supersedes: null
    - _ulid: 01KG1SX3JRA1BXNVY6A66SNSQ9
      created_at: 2026-01-28T08:00:48.728Z
      author: "@claude"
      content: |-
        ## Decisions Finalized

        ### Critical Decisions Made
        1. **MVP Channel**: Discord (not WhatsApp) - simpler API, free, easy to test
        2. **Agent Execution**: Local subprocess - spawn claude-code as child process  
        3. **Kynetic Access**: Copy source files - copy ACP modules into kynetic-bot

        ### Plan Summary
        - **27 tasks** across 5 phases (0-4)
        - Phase 0: Infrastructure (monorepo, TypeScript, testing, lint, copy ACP)
        - Phase 1: MVP (Discord -> Agent -> Discord flow)
        - Phase 2: Core (transform, DM policy, conversation storage, skills, history)
        - Phase 3: Robustness (streaming, health, context window, autonomous loop)
        - Phase 4: Polish (media, escalation, E2E tests, more channels)

        ### Next Steps After Approval
        1. Derive tasks from specs
        2. Add implementation notes to each task
        3. Break down any remaining large tasks
        4. Begin Phase 0 implementation

        Plan file: ~/.claude/plans/compressed-hugging-dolphin.md
      supersedes: null
  todos: []
- _ulid: 01KG1TCHT7HG62QECKPQ8PD996
  slugs:
    - init-monorepo
  title: Initialize pnpm monorepo workspace
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-0
  vcs_refs: []
  created_at: 2026-01-28T08:09:14.822Z
  notes:
    - _ulid: 01KG1TGPPZBB1JVGQR2829YPDN
      created_at: 2026-01-28T08:11:30.912Z
      author: "@claude"
      content: |-
        ## Goal
        Set up the pnpm monorepo workspace structure with all 6 packages configured.

        ## Files
        - package.json - Root package with workspace scripts
        - pnpm-workspace.yaml - Workspace package definitions
        - packages/core/package.json - @kynetic-bot/core
        - packages/messaging/package.json - @kynetic-bot/messaging
        - packages/channels/package.json - @kynetic-bot/channels
        - packages/memory/package.json - @kynetic-bot/memory
        - packages/agent/package.json - @kynetic-bot/agent
        - packages/bot/package.json - @kynetic-bot/bot

        ## Dependencies
        None - this is the first task.

        ## Implementation
        1. Create root package.json with pnpm workspace configuration
        2. Create pnpm-workspace.yaml with packages/* glob
        3. Create each package directory with package.json containing:
           - name: @kynetic-bot/{package-name}
           - main: dist/index.js
           - types: dist/index.d.ts
           - scripts: build, test, lint
        4. Add workspace dependencies between packages (e.g., bot depends on all others)

        ## Acceptance Criteria
        - AC-1: pnpm workspace configured with all 6 packages
        - AC-2: Each package has package.json with name, main, types
        - AC-3: pnpm install succeeds from root

        ## Verification
        Run pnpm install from project root and verify no errors.
      supersedes: null
  todos: []
- _ulid: 01KG1TCMKE85766PTWC9TKA2EY
  slugs:
    - setup-typescript
  title: Configure TypeScript project references
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-0
  vcs_refs: []
  created_at: 2026-01-28T08:09:17.678Z
  notes:
    - _ulid: 01KG1TGSST3V9PZE0J9B6A5C54
      created_at: 2026-01-28T08:11:34.075Z
      author: "@claude"
      content: |-
        ## Goal
        Configure TypeScript with project references for incremental builds across the monorepo.

        ## Files
        - tsconfig.base.json - Shared TypeScript configuration
        - tsconfig.json - Root config with project references
        - packages/core/tsconfig.json - Core package config
        - packages/messaging/tsconfig.json - Messaging package config
        - packages/channels/tsconfig.json - Channels package config
        - packages/memory/tsconfig.json - Memory package config
        - packages/agent/tsconfig.json - Agent package config
        - packages/bot/tsconfig.json - Bot package config (references all others)

        ## Dependencies
        - @init-monorepo - Package structure must exist first

        ## Implementation
        1. Create tsconfig.base.json with:
           - strict: true
           - target: ES2022
           - module: Node16 / moduleResolution: Node16
           - declaration: true
           - declarationMap: true
           - sourceMap: true
           - composite: true (for project references)
        2. Create root tsconfig.json with references to all packages
        3. Each package tsconfig.json extends base and adds:
           - outDir: ./dist
           - rootDir: ./src
           - references to dependencies
        4. Configure path aliases for @kynetic-bot/* imports

        ## Acceptance Criteria
        - AC-1: Base config with strict mode, ES2022 target
        - AC-2: Project references for incremental builds
        - AC-3: Path aliases for @kynetic-bot/* imports
        - AC-4: pnpm build compiles all packages

        ## Verification
        Run pnpm build and verify all packages compile without errors.
      supersedes: null
  todos: []
- _ulid: 01KG1TCPQB3JFQZH0TA5CHMWKV
  slugs:
    - setup-vitest
  title: Set up Vitest with test utilities
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-0
  vcs_refs: []
  created_at: 2026-01-28T08:09:19.850Z
  notes:
    - _ulid: 01KG1TGWZSV7J6VNGQM0VV0T57
      created_at: 2026-01-28T08:11:37.337Z
      author: "@claude"
      content: |-
        ## Goal
        Configure Vitest for testing across all packages with shared test utilities.

        ## Files
        - vitest.config.ts - Root Vitest configuration
        - vitest.workspace.ts - Workspace configuration for all packages
        - packages/core/vitest.config.ts - Core package test config
        - packages/core/src/test-utils/index.ts - Shared test utilities
        - packages/*/vitest.config.ts - Per-package test configs

        ## Dependencies
        - @setup-typescript - TypeScript must be configured first

        ## Implementation
        1. Install vitest, @vitest/coverage-v8 as dev dependencies
        2. Create root vitest.config.ts with:
           - globals: true
           - coverage provider: v8
           - coverage reporters: text, json, html
        3. Create vitest.workspace.ts defining all package test configs
        4. Create shared test utilities in core package:
           - Mock factories for common objects (NormalizedMessage, SessionKey)
           - Test fixtures
           - Custom matchers if needed
        5. Add test scripts to root package.json: test, test:coverage, test:watch

        ## Acceptance Criteria
        - AC-1: Vitest configured for each package
        - AC-2: Test utilities: mock factories, test fixtures
        - AC-3: pnpm test runs all tests
        - AC-4: Coverage reporting enabled

        ## Verification
        Run pnpm test and pnpm test:coverage from root.
      supersedes: null
  todos: []
- _ulid: 01KG1TCS1VP8GK0SAB6HKJDZ1A
  slugs:
    - setup-linting
  title: Configure ESLint + Prettier
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-0
  vcs_refs: []
  created_at: 2026-01-28T08:09:22.235Z
  notes:
    - _ulid: 01KG1TGZP5ZTAX4R2PXPSPCEQ3
      created_at: 2026-01-28T08:11:40.102Z
      author: "@claude"
      content: |-
        ## Goal
        Configure ESLint and Prettier for consistent code quality and formatting.

        ## Files
        - eslint.config.js - ESLint flat config
        - .prettierrc - Prettier configuration
        - .prettierignore - Prettier ignore patterns
        - package.json - Add lint/format scripts

        ## Dependencies
        - @init-monorepo - Package structure must exist

        ## Implementation
        1. Install dependencies:
           - eslint, @eslint/js
           - typescript-eslint
           - prettier, eslint-config-prettier
        2. Create eslint.config.js with flat config:
           - TypeScript parser and rules
           - Recommended rules from @eslint/js
           - Prettier compatibility
        3. Create .prettierrc with:
           - semi: true
           - singleQuote: true
           - trailingComma: es5
           - printWidth: 100
        4. Add scripts to root package.json:
           - lint: eslint packages/*/src
           - lint:fix: eslint --fix packages/*/src
           - format: prettier --write packages/*/src/**/*.ts
           - format:check: prettier --check packages/*/src/**/*.ts

        ## Acceptance Criteria
        - AC-1: ESLint with TypeScript rules
        - AC-2: Prettier for formatting
        - AC-3: pnpm lint and pnpm format work

        ## Verification
        Create a test file with lint issues, run pnpm lint, verify detection.
      supersedes: null
  todos: []
- _ulid: 01KG1TCVDS60NH6FW759CTZJQM
  slugs:
    - copy-acp-modules
  title: Copy kynetic ACP modules
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-0
  vcs_refs: []
  created_at: 2026-01-28T08:09:24.664Z
  notes:
    - _ulid: 01KG1TH2M493AF54KYF4MEDASH
      created_at: 2026-01-28T08:11:43.109Z
      author: "@claude"
      content: >-
        ## Goal

        Copy ACP (Agent Communication Protocol) modules from kynetic/lifeline for agent
        communication.


        ## Files to Copy

        FROM: ../kynetic/packages/lifeline/src/acp/

        TO: packages/agent/src/acp/


        | Source | Destination | Description |

        |--------|-------------|-------------|

        | client.ts | packages/agent/src/acp/client.ts | ACPClient class |

        | framing.ts | packages/agent/src/acp/framing.ts | JsonRpcFraming |

        | types.ts | packages/agent/src/acp/types.ts | ACP type definitions |


        ## Dependencies

        - @setup-typescript - TypeScript must be configured


        ## Implementation

        1. Create packages/agent/src/acp/ directory

        2. Copy the three files from kynetic/lifeline/src/acp/

        3. Adapt imports to local structure:
           - Update relative imports
           - Change any @kynetic/* imports to local paths
        4. Create packages/agent/src/acp/index.ts barrel export

        5. Verify all copied modules compile without errors

        6. Add documentation comment at top of each file noting:
           - Original source location
           - Date copied
           - Any modifications made

        ## Files After Copy

        - packages/agent/src/acp/client.ts - ACPClient for communicating with agents

        - packages/agent/src/acp/framing.ts - JSON-RPC framing for stdio

        - packages/agent/src/acp/types.ts - Protocol types and interfaces

        - packages/agent/src/acp/index.ts - Barrel export


        ## Acceptance Criteria

        - AC-1: Copy ACPClient, JsonRpcFraming, types from kynetic/lifeline/src/acp

        - AC-2: Adapt imports to local structure

        - AC-3: All copied modules compile without errors

        - AC-4: Document which files were copied and from where


        ## Verification

        Run pnpm build and verify agent package compiles successfully.
      supersedes: null
  todos: []
- _ulid: 01KG1TD8REHCMGXRCRN5B7TFCZ
  slugs:
    - core-types
  title: Core types, session keys, error utilities
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:38.318Z
  notes:
    - _ulid: 01KG1TK1RSH6YXP6EVS17MWAMV
      created_at: 2026-01-28T08:12:47.769Z
      author: "@claude"
      content: |-
        ## Goal
        Implement core types and utilities used across all packages.

        ## Files
        - packages/core/src/types/normalized-message.ts - NormalizedMessage type
        - packages/core/src/types/session-key.ts - SessionKey type and utilities
        - packages/core/src/types/channel-adapter.ts - ChannelAdapter interface
        - packages/core/src/utils/session-key.ts - parseSessionKey, buildSessionKey
        - packages/core/src/utils/errors.ts - Error types
        - packages/core/src/utils/logger.ts - Logging utility
        - packages/core/src/index.ts - Barrel export

        ## Dependencies
        - @copy-acp-modules - Infrastructure must be complete

        ## Implementation

        ### NormalizedMessage
        ```typescript
        interface NormalizedMessage {
          id: string;
          text: string;
          sender: {
            id: string;
            platform: string;
            displayName?: string;
          };
          timestamp: Date;
          channel: string;
          metadata: Record<string, unknown>;
          attachments?: Attachment[];
        }
        ```

        ### SessionKey Format
        agent:{agentId}:{platform}:{peerKind}:{peerId}
        Example: agent:main:whatsapp:user:+1234567890

        ### Session Key Functions
        ```typescript
        interface ParsedSessionKey {
          agent: string;
          platform: string;
          peerKind: 'user' | 'channel';
          peerId: string;
        }

        function parseSessionKey(key: string): ParsedSessionKey | InvalidSessionKeyError
        function buildSessionKey(parts: ParsedSessionKey): string
        ```

        ### Error Types
        ```typescript
        class KyneticError extends Error { code: string; context?: Record<string, unknown> }
        class UnknownAgentError extends KyneticError { code: 'UNKNOWN_AGENT' }
        class InvalidSessionKeyError extends KyneticError { code: 'INVALID_SESSION_KEY' }
        ```

        ## Acceptance Criteria
        - AC-1: NormalizedMessage with text, sender, timestamp, channel, metadata
        - AC-2: SessionKey with agent, channel, peerKind, peerId segments
        - AC-3: parseSessionKey returns structured object
        - AC-4: buildSessionKey returns formatted string
        - AC-5: Error types: KyneticError base, UnknownAgentError, InvalidSessionKeyError
        - AC-6: Unit tests for parsing edge cases (missing segments, invalid format)

        ## Verification
        Run pnpm test packages/core and verify all tests pass.
      supersedes: null
  todos: []
- _ulid: 01KG1TDAZZW5PG1MAWGTK0HKDV
  slugs:
    - session-router
  title: SessionKeyRouter for @msg-routing
  type: task
  spec_ref: "@msg-routing"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:40.607Z
  notes:
    - _ulid: 01KG1TK4T1QPJCZMAH80YXD74J
      created_at: 2026-01-28T08:12:50.881Z
      author: "@claude"
      content: >-
        ## Goal

        Implement session key router for message routing and session management.


        ## Files

        - packages/messaging/src/router.ts - SessionKeyRouter class

        - packages/messaging/src/types.ts - Router types

        - packages/messaging/src/index.ts - Barrel export

        - packages/messaging/test/router.test.ts - Unit tests


        ## Dependencies

        - @core-types - Needs SessionKey and error types


        ## Implementation


        ### SessionKeyRouter

        ```typescript

        interface SessionStore {
          get(key: string): Session | undefined;
          create(key: string): Session;
          delete(key: string): void;
        }


        class SessionKeyRouter {
          constructor(private store: SessionStore) {}

          resolveSession(message: NormalizedMessage, agentId: string): Result<Session, KyneticError>
          getOrCreateSession(key: string): Session
          closeSession(key: string): void
        }

        ```


        ### Session Type

        ```typescript

        interface Session {
          key: string;
          agent: string;
          platform: string;
          peerId: string;
          peerKind: 'user' | 'channel';
          context: Message[];
          createdAt: Date;
          lastActivity: Date;
        }

        ```


        ## Spec Acceptance Criteria (from @msg-routing)

        - AC-1: Given message from WhatsApp user to agent, when router processes, then resolves to
        unique session key

        - AC-2: Given existing session, when new message with same key, then appends to context

        - AC-3: Given unknown agent, when router resolves, then returns UnknownAgentError


        ## Verification

        Run pnpm test packages/messaging with tests covering all 3 AC.
      supersedes: null
  todos: []
- _ulid: 01KG1TDCYN853WKRH1WDE9W8VR
  slugs:
    - channel-registry-task
  title: ChannelRegistry for @channel-registry
  type: task
  spec_ref: "@channel-registry"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:42.612Z
  notes:
    - _ulid: 01KG1TK7299A31FZAFN2TE26X5
      created_at: 2026-01-28T08:12:53.193Z
      author: "@claude"
      content: >-
        ## Goal

        Implement channel adapter registry for platform plugin management.


        ## Files

        - packages/channels/src/registry.ts - ChannelRegistry class

        - packages/channels/src/types.ts - Adapter interface and types

        - packages/channels/src/index.ts - Barrel export

        - packages/channels/test/registry.test.ts - Unit tests


        ## Dependencies

        - @core-types - Needs NormalizedMessage type


        ## Implementation


        ### ChannelAdapter Interface

        ```typescript

        interface ChannelAdapter {
          readonly name: string;
          readonly platform: string;

          parseIncoming(raw: unknown): Result<NormalizedMessage, KyneticError>;
          sendMessage(target: string, message: NormalizedMessage): Promise<Result<void, KyneticError>>;
          normalizeTarget(target: string): string;
        }

        ```


        ### ChannelRegistry

        ```typescript

        class ChannelRegistry {
          private adapters = new Map<string, ChannelAdapter>();

          register(adapter: ChannelAdapter): Result<void, ValidationError>
          getAdapter(platform: string): ChannelAdapter | undefined
          listAdapters(): ChannelAdapter[]

          private validateAdapter(adapter: ChannelAdapter): ValidationError | null
        }

        ```


        ### Validation

        Check that adapter implements all required methods. Return error listing missing methods if
        invalid.


        ## Spec Acceptance Criteria (from @channel-registry)

        - AC-1: Given valid adapter, when register(), then added to registry

        - AC-2: Given registered platform, when getAdapter(), then returns correct adapter

        - AC-3: Given invalid adapter, when register(), then returns validation error with missing
        methods


        ## Verification

        Run pnpm test packages/channels with tests for adapter registration, lookup, and validation.
      supersedes: null
  todos: []
- _ulid: 01KG1TDFRYWSJ2Q97Y4PNPGD6Z
  slugs:
    - kspec-sync
  title: KspecSync for @mem-kspec-sync
  type: task
  spec_ref: "@mem-kspec-sync"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:45.502Z
  notes:
    - _ulid: 01KG1TKA7VEYKRHFN8B9BFAZ9J
      created_at: 2026-01-28T08:12:56.444Z
      author: "@claude"
      content: |-
        ## Goal
        Implement kspec shadow branch synchronization for persistent state storage.

        ## Files
        - packages/memory/src/kspec-sync.ts - KspecSync class
        - packages/memory/src/types.ts - Memory types
        - packages/memory/src/index.ts - Barrel export
        - packages/memory/test/kspec-sync.test.ts - Unit tests

        ## Dependencies
        - @core-types - Needs error types

        ## Implementation

        ### KspecSync Class
        ```typescript
        interface KspecSyncOptions {
          workdir: string;  // Project root with .kspec/
          autoCommit?: boolean;  // Default true
        }

        class KspecSync {
          constructor(private options: KspecSyncOptions) {}

          // State persistence via kspec CLI
          async commitState(type: string, data: unknown): Promise<Result<void, KyneticError>>
          async loadState(type: string): Promise<Result<unknown, KyneticError>>

          // Conflict handling
          async resolveConflict(strategy: 'ours' | 'theirs' | 'merge'): Promise<void>

          // Shadow branch operations
          async sync(): Promise<void>
          async status(): Promise<ShadowStatus>
        }
        ```

        ### Kspec CLI Usage
        Use child_process.spawn to run kspec commands:
        - kspec inbox add - Add state entries
        - kspec task note - Append conversation turns
        - kspec shadow sync - Sync with remote
        - kspec shadow status - Check status

        ### Error Handling
        - Handle CLI spawn failures
        - Parse kspec output for errors
        - Handle merge conflicts gracefully

        ## Spec Acceptance Criteria (from @mem-kspec-sync)
        - AC-1: Given state change, when commitState(), then commits to shadow branch with timestamp
        - AC-2: Given bot restart, when loadState(), then recovers all state from shadow branch
        - AC-3: Given merge conflict, when detected, then applies strategy and logs resolution

        ## Verification
        Run integration tests with real .kspec worktree.
      supersedes: null
  todos: []
- _ulid: 01KG1TDKTGZFS74P83XX93YKJF
  slugs:
    - agent-lifecycle-task
  title: AgentLifecycle for @agent-lifecycle
  type: task
  spec_ref: "@agent-lifecycle"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:49.647Z
  notes:
    - _ulid: 01KG1TKD54SA3VRSFJB7MR6C43
      created_at: 2026-01-28T08:12:59.429Z
      author: "@claude"
      content: >-
        ## Goal

        Implement agent process lifecycle management with health monitoring.


        ## Files

        - packages/agent/src/lifecycle.ts - AgentLifecycle class

        - packages/agent/src/types.ts - Agent types

        - packages/agent/src/index.ts - Barrel export

        - packages/agent/test/lifecycle.test.ts - Unit tests


        ## Dependencies

        - @core-types - Needs error types

        - Uses ACP modules copied in @copy-acp-modules


        ## Implementation


        ### AgentLifecycle Class

        ```typescript

        interface AgentConfig {
          command: string;  // e.g., 'claude-code'
          args?: string[];
          env?: Record<string, string>;
          healthCheckInterval?: number;  // ms, default 30000
          maxUnresponsiveTime?: number;  // ms, default 60000
        }


        class AgentLifecycle {
          private process: ChildProcess | null = null;
          private acpClient: ACPClient | null = null;

          async spawn(sessionKey: string, config: AgentConfig): Promise<Result<ACPClient, KyneticError>>
          async healthCheck(): Promise<boolean>
          async terminate(graceful?: boolean): Promise<void>

          getState(): 'idle' | 'spawning' | 'running' | 'unhealthy' | 'terminating'
        }

        ```


        ### Environment Variables

        Set KYNETIC_* env vars when spawning:

        - KYNETIC_SESSION_KEY

        - KYNETIC_BOT_NAME

        - KYNETIC_WORKSPACE


        ### Health Monitoring

        - Periodic health checks via ACP heartbeat

        - Track consecutive failures

        - Auto-terminate and respawn if unhealthy


        ### ACP Integration

        - Use JsonRpcFraming for stdio communication

        - Import ACPClient from ./acp/client


        ## Spec Acceptance Criteria (from @agent-lifecycle)

        - AC-1: Given session needs agent, when spawn(), then creates process with KYNETIC_* env
        vars

        - AC-2: Given agent unresponsive, when health check fails, then terminates and respawns

        - AC-3: Given session end, when cleanup(), then terminates gracefully with state save


        ## Verification

        Unit tests for lifecycle state transitions (spawn, health check, terminate).
      supersedes: null
  todos: []
- _ulid: 01KG1TDNYQD551HSS3ZHQH81GT
  slugs:
    - discord-adapter
  title: Discord channel adapter
  type: task
  spec_ref: "@channel-registry"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:51.830Z
  notes:
    - _ulid: 01KG1TKGTVBMVC0JR5YY2JABC9
      created_at: 2026-01-28T08:13:03.195Z
      author: "@claude"
      content: >-
        ## Goal

        Implement Discord channel adapter using discord.js.


        ## Files

        - packages/channels/src/adapters/discord.ts - DiscordAdapter class

        - packages/channels/test/adapters/discord.test.ts - Unit tests


        ## Dependencies

        - @channel-registry-task - Needs ChannelAdapter interface

        - npm: discord.js


        ## Implementation


        ### DiscordAdapter Class

        ```typescript

        import { Client, Message as DiscordMessage, TextChannel } from 'discord.js';


        class DiscordAdapter implements ChannelAdapter {
          readonly name = 'discord';
          readonly platform = 'discord';

          constructor(private client: Client) {}

          parseIncoming(interaction: DiscordMessage): Result<NormalizedMessage, KyneticError>
          async sendMessage(channelId: string, message: NormalizedMessage): Promise<Result<void, KyneticError>>
          normalizeTarget(target: string): string
        }

        ```


        ### parseIncoming

        Extract from Discord message:

        - id: message.id

        - text: message.content

        - sender.id: message.author.id

        - sender.platform: 'discord'

        - sender.displayName: message.author.username

        - timestamp: message.createdAt

        - channel: message.channelId

        - attachments: map message.attachments


        ### sendMessage

        - Get channel by ID: client.channels.fetch(channelId)

        - Cast to TextChannel

        - Send with content and optional embeds

        - Handle errors: rate limits (429), permissions (403), API failures


        ### normalizeTarget

        Handle formats:

        - user:123456789 -> DM channel for user

        - channel:123456789 -> Direct channel ID

        - 123456789 -> Assume channel ID


        ### Error Handling

        - Rate limit: wait and retry with exponential backoff

        - Permission denied: return structured error

        - API failure: wrap in KyneticError


        ## Acceptance Criteria

        - AC-1: Implements ChannelAdapter interface

        - AC-2: parseIncoming extracts sender, text, attachments from Discord message

        - AC-3: sendMessage sends via discord.js

        - AC-4: normalizeTarget handles Discord user/channel IDs

        - AC-5: Error handling for rate limits, permissions, API failures

        - AC-6: Integration test with mock Discord client


        ## Verification

        Run tests with mocked discord.js Client.
      supersedes: null
  todos: []
- _ulid: 01KG1TDRB07CBH2J4K25G786ET
  slugs:
    - bot-integration
  title: Basic bot integration
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 1
  tags:
    - phase-1
  vcs_refs: []
  created_at: 2026-01-28T08:09:54.272Z
  notes: []
  todos: []
- _ulid: 01KG1TE1Y9HJ47QHAH57HJNX86
  slugs:
    - msg-transformer
  title: MessageTransformer for @msg-transform
  type: task
  spec_ref: "@msg-transform"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 2
  tags:
    - phase-2
  vcs_refs: []
  created_at: 2026-01-28T08:10:04.105Z
  notes: []
  todos: []
- _ulid: 01KG1TE51N01JR7Z64GHC13Y51
  slugs:
    - dm-policy
  title: DMPolicyManager for @channel-dm-policy
  type: task
  spec_ref: "@channel-dm-policy"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 2
  tags:
    - phase-2
  vcs_refs: []
  created_at: 2026-01-28T08:10:07.285Z
  notes: []
  todos: []
- _ulid: 01KG1TE7D2JHEF3R1KYJ7TRYJ0
  slugs:
    - conversation-storage
  title: ConversationStorage for @mem-conversation
  type: task
  spec_ref: "@mem-conversation"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 2
  tags:
    - phase-2
  vcs_refs: []
  created_at: 2026-01-28T08:10:09.698Z
  notes: []
  todos: []
- _ulid: 01KG1TEACYBVQ0NNP51BBC4KSQ
  slugs:
    - skills-registry
  title: SkillsRegistry for @agent-skills
  type: task
  spec_ref: "@agent-skills"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 2
  tags:
    - phase-2
  vcs_refs: []
  created_at: 2026-01-28T08:10:12.766Z
  notes: []
  todos: []
- _ulid: 01KG1TECJE69VX6XWJD3T8F1FZ
  slugs:
    - conversation-history
  title: ConversationHistory for @msg-history
  type: task
  spec_ref: "@msg-history"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 2
  tags:
    - phase-2
  vcs_refs: []
  created_at: 2026-01-28T08:10:14.989Z
  notes: []
  todos: []
- _ulid: 01KG1TEEK47KKFMSE6Z3RNZXMP
  slugs:
    - transform-integration
  title: Transform integration into bot
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 2
  tags:
    - phase-2
  vcs_refs: []
  created_at: 2026-01-28T08:10:17.060Z
  notes: []
  todos: []
- _ulid: 01KG1TEPNTSVQ30A0ZB267MHJ8
  slugs:
    - stream-coalescer
  title: StreamCoalescer for @msg-streaming
  type: task
  spec_ref: "@msg-streaming"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 3
  tags:
    - phase-3
  vcs_refs: []
  created_at: 2026-01-28T08:10:25.338Z
  notes: []
  todos: []
- _ulid: 01KG1TERZ7S69XN92EBPBT359Y
  slugs:
    - channel-lifecycle-task
  title: ChannelLifecycle for @channel-lifecycle
  type: task
  spec_ref: "@channel-lifecycle"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 3
  tags:
    - phase-3
  vcs_refs: []
  created_at: 2026-01-28T08:10:27.686Z
  notes: []
  todos: []
- _ulid: 01KG1TETY3EBFGT1BWTQ0NWZQ4
  slugs:
    - context-window
  title: ContextWindowManager for @mem-context-window
  type: task
  spec_ref: "@mem-context-window"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 3
  tags:
    - phase-3
  vcs_refs: []
  created_at: 2026-01-28T08:10:29.699Z
  notes: []
  todos: []
- _ulid: 01KG1TEX0F7HVTTAGH9EBRC1DT
  slugs:
    - autonomous-loop
  title: AutonomousLoop for @agent-autonomous
  type: task
  spec_ref: "@agent-autonomous"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 3
  tags:
    - phase-3
  vcs_refs: []
  created_at: 2026-01-28T08:10:31.823Z
  notes: []
  todos: []
- _ulid: 01KG1TEZG2CMJ3CKE1HMSJZQHA
  slugs:
    - streaming-integration
  title: Streaming integration into bot
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 3
  tags:
    - phase-3
  vcs_refs: []
  created_at: 2026-01-28T08:10:34.369Z
  notes: []
  todos: []
- _ulid: 01KG1TF89D2BAD47YYTG6AXTPE
  slugs:
    - media-handler
  title: MediaHandler for @channel-media
  type: task
  spec_ref: "@channel-media"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 4
  tags:
    - phase-4
  vcs_refs: []
  created_at: 2026-01-28T08:10:43.373Z
  notes: []
  todos: []
- _ulid: 01KG1TFBJJMXHTYAY09H0G3VXH
  slugs:
    - escalation-handler
  title: EscalationHandler for @agent-escalation
  type: task
  spec_ref: "@agent-escalation"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 4
  tags:
    - phase-4
  vcs_refs: []
  created_at: 2026-01-28T08:10:46.737Z
  notes: []
  todos: []
- _ulid: 01KG1TFDZ926K9T6TGVDCBWBFH
  slugs:
    - e2e-tests
  title: E2E integration test suite
  type: task
  spec_ref: null
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 4
  tags:
    - phase-4
  vcs_refs: []
  created_at: 2026-01-28T08:10:49.193Z
  notes: []
  todos: []
- _ulid: 01KG1TFGK356NFMMZ0GST2A6XA
  slugs:
    - additional-adapters
  title: Additional channel adapters (WhatsApp/Slack)
  type: task
  spec_ref: "@channel-registry"
  meta_ref: null
  status: pending
  blocked_by: []
  depends_on: []
  context: []
  priority: 4
  tags:
    - phase-4
  vcs_refs: []
  created_at: 2026-01-28T08:10:51.875Z
  notes: []
  todos: []
